# 链交互工具（原ctool）操作指南

|时间|修改人|修改事项|PlatONE版本|
|:--|:--|:--|:--|
|2020.04.28|邓甫洋|初稿|v0.9.9 - stable|
|2020.05.07|邓甫洋|初稿review|v0.9.9 - stable|

[TOC]

## 定义 Definition

### 名词定义

文档中涉及的名词定义：

* 账户account：区分于链上的账户（外部账户EOA, 合约账户contract account）的概念，为本地端（local）的一个概念。账户（地址）由随机生成的私钥产生。详情见关系图
* 用户user：账户地址进行用户注册操作得到对应的用户。详细参考
* 用户注册表：存储账户进行用户注册时提交的相关信息。
* 用户平台：审核通过的注册用户信息会被添加到用户平台。
* 有效用户：用户平台中的用户有两种状态，有效以及无效，仅当用户为有效状态时，该用户可以使用其拥有的角色的权限。当用户被禁用或被删除时（统称为无效），无法享有链管理权限。
* 角色role：有效用户可以进一步注册角色，不同的角色拥有不同的链管理权限。详细参考[]()
* （用户）角色注册表：存储用户角色注册时提交的相关信息
* 普通用户：有效但无任何角色的用户。
* 角色用户：拥有角色的有效用户。
* cns平台：存储合约cns注册信息。

### 定义之间的关联

* **关系表**：
account命令:
  * 账户地址相关操作 -（与公私钥对绑定）
    * new
    * delete
    * update (changepassphrase)
    * lock
    * unlock
  * EOA账户操作 -（以太坊原生概念，链上）
    * transfer
    * balance
  * User操作 -（PlatONE权限模型中的概念，链上）
    * register
    * ......

* **关系图**：

```plantuml
rectangle local{
agent private_key as prk
database keystore
agent password

package account {
  agent address as A
  A .. password
}
card crypto_module as crypto
}

prk .> A: gen
prk <--> crypto: en/decode
crypto <--> keystore
crypto <- password

rectangle operations{
card transfer
card register
card deploy

transfer .. deploy
deploy .. register
}

A -> transfer
A -> register
A -> deploy

rectangle PlatONE{
package state_root{
  package EOA{
    agent address as B
    agent balance
  }
  package 用户user{
    package 用户平台 as User{
      agent address as C
    }
    package 角色role as Role{
      agent roles
    }
    package 用户注册表 as UserReg{
    }
    package 角色注册表 as RoleReg{
    }
  }
  package contract_account{
    agent contract_address as caddr
    agent storage
  }
  EOA .. contract_account
  /'User ..contract_account'/
  storage ..|> 用户user
  UserReg . RoleReg
  C . Role
  RoleReg --> Role
  UserReg --> User
}
}

transfer -> EOA
register -> 用户user
deploy -> contract_account
```

## 模板 Template

* **描述**：
* **参数**：
  * 必选参数：
  * 可选参数：

* **操作**：
  * 重构前：

  * 重构后：

* **输出结果**：

* **备注**：

## 0. 全局选项

### 0.1 config.json

**配置文件**:

* 用于存储部分全局选项对应的值，以减少用户重复输入。
* 每次程序启动都会读取配置文件中的值并赋值到`config`对象中

```json
config.json (template)
{
  "url":"http://NODE-IP:RPC-PORT",
  "keystore":"DEFAULT_KEYSTORE_FILE",
  "account":"0xDEFAULT_ACCOUNT"

  // 暂未使用
  // "gas":"0x0",
  // "gasPrice":"0x0",
}
```

### 0.2 账户地址选择

* **描述**：使用本地账户地址发送交易，对应的RPC调用方式则为`eth_sendRawTransaction`。选择远程节点存储的账户地址发送交易，对应的RPC调用方式则为`eth_sendTransaction`。
* **参数**：
  `--account`:
  * 指定发送交易的账户地址。如果同时还存在`--local`以及`--keystore`选项，则使用的是本地keystore中存储的账户地址，若该地址与`--account`不匹配，则会报错。
  * 当只提供`--account`时，则使用远程节点所存储的账户地址，若对应值为空，则使用默认地址`0X00...0`。

  `--local`: 从本地默认的kerystore file文件夹去寻找keystore文件
  `--keystore <file>`: 指定本地keystore文件的位置，优先度高于`--local`

### 0.3 远程节点连接

* **描述**：指定远程节点的IP进行连接
* **参数**:
`--url <string>`：通过--url与全局变量config.Url获取URL:
  * 当未提供--url时,使用变量config.Url中的值
  * 当提供--url时，读取--url中的值并覆盖config.json中url键对应的值
  * 既未提供--url且全局变量config.Url的值为空，报错并提示错误

### 0.4 不等待交易回执结果 --sync*

* **描述**：主要用于链交互写操作，默认为同步等待交易回执查询的返回结果。
* **参数**:
`--sync`：不查询交易回执，直接返回结果，返回结果为Transaction Hash，在网络环境较差时建议使用该参数。若要进一步查询交易回执，在一段时间后可通过`contract methods`命令进行查询 (详见Section 2.4)。

### 0.5 其他全局选项

* **描述**：链交互操作需要进行的全局配置
* **参数**:
`--gas <num>`:            设置代码执行的最大允许量，以避免无限循环。默认值为(TODO)
`--gas-price <num>`:      设置执行链交互命令时单位gas所需消耗的XX数量。默认值为(TODO)

## 1. 用户操作 account

针对账户地址的相关操作。

### 1.1 用户转账 account transfer

* **描述**：使用账户进行转账操作
* **参数**：
  * 必选参数：

  ```param
  <to>:         收款方账户地址
  <value>:      转账金额，单位（暂无）
  ```  

* **操作**：
账户地址0xb239401ecf8427f17c6de134d6a6bddd3100251f向账户地址0X123转账10 wei

  * 重构前：

  ``` bash
  # 通过sendTransaction方式:
  ctool transfer --from "0xb239401ecf8427f17c6de134d6a6bddd3100251f" --to "0X123" --value "10"

  # 通过sendRawTransaction方式:
  ctool transfer --from --to --value --pk
  // --pk (deprecated): private key file. If the argument is null, read from default path (./test/privateKeys.txt).
  ```

  * 重构后：
  
  ```bash
  # 通过sendTransaction方式
  ctool account transfer "0X123" "10"
  ## 指定发送交易账户
  ctool account transfer "0X123" "10" --account "0xb239401ecf8427f17c6de134d6a6bddd3100251f"
  
  # 通过sendRawTransaction方式发送
  ctool account transfer "0X123" "10" --keystore "keystore.json"
  ```

* **输出结果**：

  ```bash
  # 操作成功
  ## 同步查询
  result: Operation Succeeded
  ## 异步查询
  result: transaction hash is <transaction hash>

  # Error
  ## 通过sendTransaction方式
  ### 输入无效金额
  Fatal: parse value param error: strconv.ParseInt: parsing "x0": invalid syntax
  ### 转账金额不足
  Fatal: send Transaction through http error: execute eth_sendTransaction rpc call error: insufficient funds for value
  ### 转账账户无效
  Fatal: send Transaction through http error: execute eth_sendTransaction rpc call error: unknown account

  ## 通过sendRawTransaction方式
  略
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`evm.Transfer(...)`

### 1.2 用户注册 account register-user

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：对拥有的账户进行用户注册（User），审核通过的账户地址及其个人信息将被记录在用户平台。只有进行了用户注册的账户才能进一步进行角色注册申请。可以在用户注册阶段附上角色申请，管理员在审核通过该账户后，会进一步进行角色添加。
* **参数**：
  * 必选参数：

  ```param
  <account>：      用户账户地址
  <name>：         用户名
  <tel>：          用户电话信息
  <email>：        用户邮箱信息
  ```  

  * 可选参数：
  
  ```param
  --roles array<string>:  申请注册的一个或多个角色名，格式为"["<role>"]"或者"["<role1>",...,"<role3>"]"
  --remark string:        用户备注信息
  ```

* **操作**：
用户注册
  * 重构前：

  ```bash
  ctool invoke --addr "0xf7e769f67be5bf06d5712c355e293ef0d4c685fc" --func 'registerUser' --param '{"address":"0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe","name":"xiaoluo","mobile":"13111111111","email":"123@126.com","roles":["chainAdmin"],"remark":"平台用户申请"}' --abi "userRegister/userRegister.cpp.abi.json" --config "cnsManager/user.json"

  ctool cnsInvoke --cns "__sys_UserRegister" --func 'registerUser({"address":"0xb239401ecf8427f17c6de134d6a6bddd3100251f","name":"Alice","mobile":"13111111111","email":"alice@wx.bc.com","roles":["scDeployer, nodeAdmin"],"remark":"平台用户申请"})' --abi "~/PlatONE-Go/release/linux/conf/contracts/userRegister.cpp.abi.json" --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool account register-user "0xb239401ecf8427f17c6de134d6a6bddd3100251f" "Alice" "13111111111" "alice@wx.bc.com"
  // 省去填写"__sys_UserRegister"合约名 以及"registerUser"方法名的繁琐步骤
  // 用户需要填写的信息更加明确

  # optonal flags:
  ## 角色信息
  ctool account register-user --addr ... ... --roles '["contractDeployer", "nodeAdmin"]'

  ## 用户备注信息
  ctool account register-user --addr ... ... --remark "平台用户申请"
  ```

* **输出结果**：

```bash
  # 成功
  ## 同步查询
  result: Operation Succeeded

  # 失败
  同 2.3
```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int registerUser(const char* registJson)`
  contract：`userRegister`
  * `register-user`有必填信息，因此单独列出一个register-roles

### 1.3 用户角色注册 account register-roles

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：用户通过有效用户的账户地址进行角色注册申请，一个用户可以申请并拥有多种角色。角色用户享有更多的链管理权限，详情请参考PlatONE白皮书权限模型。
* **参数**：
  * 必选参数：

  ```param
  <roles>:    申请注册的一个或多个角色名，格式为"["<role>"]"或者"["<role1>",...,"<role3>"]"
  ```

* **操作**：
  * 重构前：

  ``` bash
  # 角色注册合约地址0xf8f1bec07e2556e6be2371f441f0a1ce9c8b737b
  ctool invoke --addr " " --func 'registerRole' --param '["nodeAdmin"]' --abi "roleRegister/roleRegister.cpp.abi.json" --config "cnsManager/user.json"

  ctool cnsInvoke --cns "__sys_RoleRegister" --func 'registerRole("["nodeAdmin"]")' --abi "~/PlatONE-Go/release/linux/conf/contracts/roleRegister.cpp.abi.json" --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool account register-roles --roles ["nodeAdmin"]
  ```

* **输出结果**：

```bash
  # 成功
  ## 同步查询
  result: OK: [RoleRegister] [registerRole] Register success

  # 失败
  同 2.3
```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int registerRole(const char* roles)`
  contract：`roleRegister`

### 1.4 用户信息更新 account update

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：更新用户的电话、邮箱等相关信息，普通用户（无角色/无权限用户）只能修改自己的信息，无法修改其他用户的信息。

* **参数**：
  * 必选参数：
  `<address>`：  （选择进行更新的）用户账户地址

  * 可选参数
  `--mobile <number>`：     用户电话信息（更新）
  `--email string`：     用户邮箱信息（更新）

* **操作**：

  * 重构前:

  ```bash
  ctool cnsInvoke --cns "__sys_UserManager" --func 'update("0xb239401ecf8427f17c6de134d6a6bddd3100251f",{"address":"0x08e7988e60ab5aa49d1f7aa9435ac91b9fcf772c","name":"Alice","mobile":"1312222","email":"123@qq.com","status":0})' --abi "~/PlatONE-Go/release/linux/conf/contracts/userManager.cpp.abi.jso" --config "../config.json"
  // 输入参数有问题?
  ```

  * 重构后:

  ```bash

  # optional flags：
  ## 修改用户电话
  ctool account update "0xb239401ecf8427f17c6de134d6a6bddd3100251f" --mobile "1312222"

  ## 修改用户邮箱
  ctool account update "0xb239401ecf8427f17c6de134d6a6bddd3100251f" --email "123@qq.com"
  ```

* **输出结果**：
  
```bash
  # 成功
  ## 同步查询
  result: 更新记录成功

  # 失败
  同 2.3
```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int update(const char* userAddr, const char* updateJson)`
  contract：`userManager`

### 1.5 用户信息查询 account query

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：根据查询键值以及辅助选项进行信息的筛选查询，返回所有匹配成功的数据对象
* **参数**：

  * 可选参数：
  用户信息查询，用于用户信息更新。

  ```param
  <account>:                查询键，通过用户账户地址或账户名称进行查询（返回结果唯一）

  // 未启用
  --name string：           查询键，通过用户账户名进行查询（返回结果唯一）
  ```

  * 待商榷参数（暂未实现）：


  ```param
  --status int：            查询键，通过用户状态、注册状态进行查询。用户状态：0有效，1禁用, 2删除。注册状态：1申请中，2已批准，3拒绝
  --roles array<string>：   查询键，通过用户角色进行查询，格式为"["<role>"]"
  --reg string：            辅助选项，通常搭配--status进行使用。参数为"user",即对用户注册表进行查询；参数为"role",即对用户角色注册表进行查询。

  --display <num>：         辅助选项，设置查询对象的显示数目。搭配查询键进行使用。若输入显示数目大于实际对象数目，则显示全部查询对象。反之，显示前display条数目，或使用--index进行辅助显示。输入为空或无--display选项时，则返回所有满足条件的查询对象。
  --index <num>:            辅助选项，搭配--display使用，默认为0。显示第display*index条至第display*(index+1)条查询信息，若display*index大于实际对象数目，则忽略--index选项的作用。若实际查询到的对象数目为n, 且display*index<n<display*(index+1),则显示第display*index条至第n条查询信息。
  ```

* **操作**：
用户信息和用户角色信息分别来自不同系统合约的存储中，重构后我们把用户信息与角色信息在内部进行关联后再反馈给用户。（未实现）
  * 重构前：

  ``` bash
  # 1 通过用户账户地址查询用户信息
  ## 步骤1：
  ctool invoke --addr "0x6c990c0f1ae07222c7b7dcb2b68b936d0008ca57" --func 'getAccountByAddress' --param "0xb239401ecf8427f17c6de134d6a6bddd3100251f" --abi "userManager/userManager.cpp.abi.json" --config "cnsManager/config.json"
  ## 步骤2：
  getRolesByAddress

  # 2 通过用户账户名查询用户信息
  ## 步骤1：
  ctool invoke --addr "0x6c990c0f1ae07222c7b7dcb2b68b936d0008ca57" --func 'getAccountByName' --param "xiaoluo" --abi "userManager/userManager.cpp.abi.json" --config "cnsManager/config.json"

  ctool cnsInvoke --cns "__sys_UserManager" --func 'getAccountByName("Alice")' --abi "~/PlatONE-Go/release/linux/conf/contracts/userManager.cpp.abi.json" --config "../config.json"
  ## 步骤2：
  getRolesByName

  # 3 通过角色名查询角色信息
  ## 步骤1：
  ctool invoke --addr "0x1df9e46ccaf981f993fe26a6eb52a6c3fd7193df" --func 'getAccountsByRole' --param "chainAdmin" --abi "roleManager/roleManager.cpp.abi.json" --config "cnsManager/config.json"
  ## 如果角色存在则用户状态一定为有效？不一定
  ## 步骤2：isValidUser(for循环查询，增加负担？)

  # 5 通过状态查询注册表信息
   ## 用户注册表

    ## 角色注册表
  ```

  * 重构后：

  ```bash
  # 1 通过用户账户地址查询用户信息
  ctool account query "0xb239401ecf8427f17c6de134d6a6bddd3100251f"

  # 2 通过用户账户名查询用户信息
  ctool account query "xiaoluo"

  # 3 通过角色名查询用户信息 （暂未实现）
  ctool account query --roles ["chainAdmin"]

  # 4 通过状态查询用户信息 （无对应接口，未实现）
  ctool account query --status "0" --display "10" --index "2"
  // 0:可用; 1:禁用; 2:删除 不对删除状态进行查询？

  # 5 通过状态查询注册表信息 （暂未实现）
  ## 用户注册表
  ctool account query --status "1" --reg "user" --display "10" --index "2"
  // 1审核中，2已激活，3已拒绝

  ## 角色注册表 （暂未实现）
  ctool account query --status "0" --reg "role" --display "10" --index "2"
  // 1 申请中 2 已批准 3 已拒绝
  ```

* **输出结果**：

  ```bash
  // 基于对用户信息保护的目的，返回的数据结构中不包含--tel, --email信息？

  # 通用格式
  ## 成功
  查询到XX条信息，显示XX条： （暂未实现）
  result: %s

  # 失败
  同 2.3

  # 1 通过用户账户地址查询用户信息
  
  用户信息对象：
  json<userInfo>
  {
    "adress": ,
    "name": ,
    "email": ,
    "mobile": ,
    "status":
  }

  ## 成功：
  result: {
    "code":0,
    "msg":"succeed",
    "data":{
      "address":"0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe",
      "name":"xiaoluo",
      "mobile":"1312222",
      "email":"123@qq.com",
      "status":2
    }
  }

  # 2 通过用户账户名查询用户信息
  结果同# 1

  # 3 通过角色名查询用户信息 （暂未实现）
  array of json<roleInfo>  
  {
    "address": ,
    "name": ,
    "roles":
  }

  成功：
  result: {
    "code":0,
    "msg":"Success",
    "data":[{
      "name":"xiaoluo",
      "address":"0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe"}],
      "roles":
  }

  # 4 通过状态查询用户信息
  N/A

  # 5 通过状态查询注册信息 （暂未实现）
  
  用户注册表
  json<registerInfo>
  {
    "user_address": ,
    "name": ,
    "mobile": ,
    "email": ,
    "remark": ,
    "user_state": ,
    "auditor_address": ,
    "roles":
  }

  （待补充）

  角色注册表 （暂未实现）
  json<registerUserInfo>
  {
    "userAddress": ,
    "userName": ,
    "roleRequireStatus": ,
    "requireRoles": ,
    "approver":
  }

  （待补充）
  ```

* **备注**：
  * 用户注册合约中未使用的方法：
    * `userRegister.getAccountByAddress()`
    * `userRegister.getAccountByUsername()`

  * 调用RPC接口：`eth_call`
  * 对应方法：
    * `const char* getAccountByAddress(const char* address) const`
    contract： `userManager`
    * `const char* getRolesByAddress(const char *address)const`
    contract： `userManager`
    * `const char* getAccountByName(const char* name) const`
    contract： `userManager`
    * `const char* getRolesByName(const char *name)const`
    contract： `userManager`
    * `const char* getAccountsByRole(const char *role)cont`
    contract：`roleManager`
    * `const char* getRegisterInfosByStatus(int status, int pageNum, int pageSize) const`
    contract：`roleRegister`
    * `const char* getAccountsByStatus(int pageNum, int pageSize, int accountStatus) const`
    contract：`userRegister`

### 1.6 用户状态查询 account state // status?

* **描述**：查询用户的当前状态，当前状态有以下几种可能：1. 账户未注册。2. 账户审核中。3. 账户审核被拒绝。4. 无效用户（被管理员禁用或删除）。5. 普通用户（有效用户，无角色）。6. 权限用户，审核中角色：`<num>`，已拥有角色：`<num>`。
* **参数**：
  * 必选参数：

  ```param
  <account>：  查询键，通过用户账户地址或账户名进行状态查询（返回结果唯一）
  ```

* **操作**：
  * 重构前：

  ```bash
  # 步骤1：
  userRegister:getStatusByAddress
  ctool cnsInvoke --cns "__sys_UserManager"  --func 'isValidUser("0xb239401ecf8427f17c6de134d6a6bddd3100251f")' --abi "~/PlatONE-Go/release/linux/conf/contracts/userManager.cpp.abi.json" --config "../config.json"
  # 步骤2：userManager: isValidUser
  # 步骤3：roleRegister: getRegisterInfoByAddress/ Name
  # 步骤4：roleManager: getRolesByAddress/ Name
  ```

  * 重构后：

  ```bash
  ctool account status "0xb239401ecf8427f17c6de134d6a6bddd3100251f"
  ```

* **输出结果**:

  ```bash
  返回类型：string<status>
  返回以下结果中的其中一个：
  
  # 步骤1：
  1. 账户未注册
  2. 账户审核中
  3. 账户审核被拒
  # 步骤2：
  4. 无效用户（被管理员禁用或删除）
  # 步骤3：
  5. 普通用户（有效用户，无角色）
     审核中角色：...
  # 步骤4：
  6. 权限用户，
     审核中角色：...
     已拥有角色：...

  （待补充）
  getRolesByAddress/Name
  result: {
    "code":0,
    "msg":"Success",
    "data":["contractDeployer","contractAdmin"]
  }
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：
    * `int getStatusByAddress(const char* address) const`
    contract：`userRegister`
    * `getStatusByName`
    contract： `userRegister`

## 2. 合约操作 contract

针对合约的相关操作

### 2.1 合约部署 contract deploy

[//]: <来源PlatONE_WIKI/zh-cn/WASMContract/编译部署及调用.md>
[//]: <一致：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：合约部署者将编写好的合约部署到链上。支持wasm虚拟机合约和evm虚拟机合约部署。
* **参数**：
  * 必选参数：

  ```param
  <codeFile>：      合约编译后得到的二进制代码文件路径
  ```

  * 可选参数：

  ```param
  --abi <file>：    合约abi文件路径，部署wasm合约必须提供，部署evm合约不需要提供
  --vm value:       选择进行部署的合约（目前支持evm合约，wasm合约，默认为wasm合约）
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool deploy --abi "appContract/my_contract/my_contract.cpp.abi.json" --code "appContract/my_contract/my_contract.wasm" --config "./config.json"
  ```

  * 重构后：

  ```bash
  ## wasm合约
  ctool contract deploy "./test/test_case/wasm/contracta.wasm" --abi "./test/test_case/wasm/contracta.cpp.abi.json"

  ## evm合约
  ctool contract deploy "./test/test_case/sol/storage_byzantium_065.bin" --vm evm
  ```

* **输出结果**：

  ```bash
  # 成功：
  ## 同步查询
  result: contract address is 0x2ee8d0545ebd20f9a992ff54cb0f21a153539206

  # 失败：
  可能失败的原因，具体错误信息请参照代码
  1. rlp编码失败
  2. Http发送失败：
    * 无返回结果
    * 发送出错
    * 发送成功，状态码不为200
  3. Rpc调用失败
    * RPC JSON消息解析失败
    * RPC调用失败：<失败信息>
  4. 交易回执查询失败
    * 查询超时
    * 交易执行失败，状态码为0x0
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`evm.Create(...)`

### 2.2 合约迁移 contract migrate

* **描述**：将旧合约的数据迁移到新合约中。
* **参数**：
  * 必选参数：

  ```param
  <address>:  旧合约账户地址
  <to>:       新合约账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool migInvoke --addr ${destination_contract_addr} --func 'migrateFrom' --param ${source_contract_addr}  --config ${ctool.json}
  ```

  * 重构后：

  ```bash
  ctool contract migrate ${destination_contract_addr} ${source_contract_addr}
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步查询
  result: Operation Success

  # 失败：
  略
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func migProcess(*state.StateDB, common.Address, common.Address, []byte) ([]byte, uint64, error)`
  * 目前接口存在，但并未启用相应功能，所以操作后storage trie并未从旧合约复制到新合约中
  * 进一步：调用返回结果确认

### 2.3 合约执行 contract execute

[//]: <来源PlatONE_WIKI/zh-cn/WASMContract/编译部署及调用.md>

* **描述**：调用并执行合约中的方法。支持wasm虚拟机合约和evm虚拟机合约方法的调用。仍然可以通过该命令实现系统合约的调用
* **参数**：
  * 必选参数：

  ```param
  <contract>:           合约账户地址或合约名称
  <function>:           被执行合约的具体方法以及参数，
                        格式<funcname>(<param1>,<param2>)
                        或者<funcname>()。示例：getName()。
  ```

  * 可选参数：

  ```param
  --param value:        合约方法的入参，当有多个入参时，一个--param对应一个参数。格式：--param <value1> --param <value2>
  --abi <file>:         合约abi文件路径。wasm虚拟机合约abi文件未指定时会默认从链上获取(未启用)。evm虚拟机合约执行必须指定abi文件，否则执行出错。
  --vm value:           选择进行执行的合约（目前支持evm合约，wasm合约，默认为wasm合约）
  ```

* **操作**：
  * 重构前：

  ``` bash
  
  # 通过合约地址调用合约
  ## 写操作
  ### 形式1
  ctool invoke --addr "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" --abi "appContract/my_contract/my_contract.cpp.abi.json"   --config "./config.json" --func "setName" --param "wxbc"
  ### 形式2
  ctool invoke --addr "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" --abi ... ... --func "setName(wxbc)"
  //建议写成第二种形式
  
  ## 只读操作
  ctool invoke --addr "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" --abi "appContract/my_contract/my_contract.cpp.abi.json" --config "./config.json" --func "getName"

  # 通过合约名称调用合约（cns服务）
  ctool cnsInvoke --cns "test" --abi "appContract/my_contract/my_contract.cpp.abi.json" --config "./config.json" --func "setName(wxbc)"
  //--cns (deprecated?)
  ```

  * 重构后：

  ```bash
  # 通过合约地址调用合约
  ## wasm合约（默认）
  ctool contract execute "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" "setName(wxbc)"
  ## evm合约
  ctool contract execute ... ... --vm evm

  # 通过合约名称调用合约（cns服务）
  ctool contract execute "test" "setName(wxbc)"
  // 注：evm合约，可以通过CNS注册合约名，但暂时不支持通过合约名称进行合约调用。
  ```

* **输出结果**：

  ```bash
  # 成功
  request json data: %s
  response json: %s
  ## 写操作
  * trasaction hash: %s
  ## 只读操作
  * result: %v
  * result: []

  # 示例
  ## 写操作
  transaction hash: " "
  ## 只读操作
  result: wxbc

  # 失败
  略
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction` or `eth_call`
  * 对应方法：N/A

### 2.4 合约方法查询 contract methods*

* **描述**：查询指定合约所拥有的方法，返回方法列表。
* **参数**：
  * 可选参数：

  ```param
  --contract <string>:  合约账户地址（或者合约名称，尚未实现
  --abi <file>:         合约abi文件路径。wasm虚拟机合约abi文件未指定时会默认从链上获取。evm虚拟机合约执行必须指定abi文件，否则执行出错。
  ```

* **操作**：
  * 重构前：
  无
  * 重构后：
  
  ```bash
  # 通过abi获取并显示所有合约方法
  ctool contract methods --abi "appContract/my_contract/my_contract.cpp.abi.json"

  # 通过合约地址获取并显示所有合约方法
  ctool contract methods --contract "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206"
  // 注：前提是该合约地址的abi文件按照对应命名格式存储于./abi文件夹中
  ```

* **输出结果**：
-------contract methods list----------
Method 1: retreive() int32
Method 2: store(num int32)
... ...

* **备注**：
无

## 3. 合约域名系统服务 cns

针对合约域名系统服务的相关操作。目前仅支持wasm合约使用该服务，evm合约可以进行cns注册，但无法通过合约名称实现合约调用。

### 3.1 合约cns注册 cns register

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：将合约注册到cns平台中，注册后的合约不仅可以通过合约账户地址进行调用执行，还可以通过其对应的合约名称进行执行。
* **参数**：
  * 必选参数：

  ```param
  <name>:          在cns中注册的合约名称
  <version>:       在cns中注册的版本号，（补充）。格式："X.X.X.X"
  <address>:       进行注册的合约的账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'cnsRegister' --param "test" --param "1.0.0.0" --param "0x08644ba5e0dd71d3d7cbb58913a099c2f3ca403f"  --abi "cnsManager/cnsManager.cpp.abi.json" --config "cnsManager/config.json"

  "cnsRegister('test', 1.0.0.0, 0x08644ba5e0dd71d3d7cbb58913a099c2f3ca403f)"
  ```

  * 重构后：

  ```bash
  cns register "test" "1.0.0.0" "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206"
  // 省去填写cnsProxy合约地址
  // 用户输入参数时更加明确
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步查询
  result: cnsRegister succeed!

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int cnsRegister(const char *name, const char *version, const char *address)`
  contract: `cnsManager`

### 3.2 合约cns注销 cns unregister

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：注销注册在cns平台中的合约。通过修改该合约数据对象的状态字段实现，因此该合约的cns注册数据仍然会保留在cns平台中，可以通过`cns query`命令查询到。
* **参数**：
  * 必选参数：

  ```param
  <name>：        合约在cns中注册的合约名称
  <version>:      合约在cns中注册的版本号
  ```

  * 可选参数：

  ```param
  --ver string:     合约在cns中注册的版本号，默认为"latest"

* **操作**：
  * 重构前：

  ``` bash
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'cnsUnregister' --param "test"  --param "1.0.0.0" --abi "~/PlatONE-Go/release/linux/conf/contracts/cnsManager.cpp.abi.json" --config "../config.json"
  ```

  * 重构后：

  ```bash
  # 注销最新版本
  ctool cns unregister "test"

  # 注销指定版本
  ctool cns unregister "test" --ver "1.0.0.0"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步操作
  result: cnsUnregister succeed!

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int cnsUnregister(char *name, char *version)`
  contract: `cnsManager`

### 3.3 合约cns解析 cns resolve

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：通过合约名称以及版本号（默认为"latest"）解析出对应的账户地址。一个合约名可以对应多个（在注册的）合约地址，通过版本号解析出对应的合约地址，但在cns平台中已注销的合约名对应的版本号无法解析出相应的账户地址。
* **参数**：
  * 必选参数：

  ```param
  <name>：          合约在cns中注册的合约名称
  ```

  * 可选参数：

  ```param
  --ver string:     合约在cns中注册的版本号，默认为"latest"
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'getContractAddress' --param "test" --param "1.0.0.0" --abi "~/PlatONE-Go/release/linux/conf/contracts/cnsManager.cpp.abi.json" --config "../config.json"

  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'getContractAddress' --param "test" --param "1.0.0.0" --abi "cnsManager/cnsManager.cpp.abi.json" --config "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  # 查询最新版本
  ctool cns resolve "test"

  # 查询指定版本
  ctool cns resolve "test" --ver "1.0.0.0"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: <address>
  ## 对应合约名称的版本已注销
  result: <null>

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：`const char *getContractAddress(char *name, char *version) const`
  contract: `cnsManager`

### 3.4 合约cns信息查询 cns query

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：根据查询键值以及辅助选项进行cns注册信息的筛选查询，返回所有匹配成功的数据对象。
* **参数**：
  * 可选参数：

  ```param
  --contract <address>: 查询键，通过合约账户地址或者合约名称进行查询
  --user <address>：    查询键，通过用户账户地址进行查询，查询该用户注册在cns的合约 // 使用--user体现了PlatONE的权限模型特色
  --all                 查询键，显示所有cns中所有注册的对象（不显示已注销的信息）

  // 名称待定TODO
  --display <num>：     x
  --index <num>：       x

  // 尚未实现
  --detail:             ？？？
  --addr <address>:     查询键，通过合约账户地址进行查询（返回结果唯一？？？）
  --name string：       查询键，通过合约名称进行查询（返回结果不唯一）

  ```

  * 待商榷参数

  ```param
  --status bool:        查询键，通过合约在cns的注册状态进行查询，可能存在的状态：注册中（true）或注销(false)
  ```

* **操作**：
  * 重构前：

  ``` bash
  # 1 查询已注册合约 list registered contracts
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'getRegisteredContracts' --param "0" --param "10" --abi "~/PlatONE-Go/release/linux/conf/contracts/cnsManager.cpp.abi.json" --config "../config.json"

  # 2 通过名称查询注册历史 get contract history
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'getHistoryContractsByName' --param "test" --abi "~/PlatONE-Go/release/linux/conf/contracts/cnsManager.cpp.abi.json" --config "../config.json"

  # 3 通过注册者进行查询 query contract register info
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'getRegisteredContractsByAddress' --param "0x01a369998e4a141c5e2b40dbcbaf4a601d57cfa5" --param "0" --param "10" --abi "cnsManager/cnsManager.cpp.abi.json" --config "cnsManager/config.json"

  # 4 通过合约地址进行查询
  cnsManager: getContractInfoByAddress

  # 5 合约是否注册
  详细见 3.5
  ```

  * 重构后：

  ```bash
  # 1 查询已注册的合约
  ctool cns query --all --display "10" --index "0"
  # 2 通过合约名称进行查询 - 查询该名称注册历史
  ctool cns query --contract "test"
  # 3 通过注册者进行查询
  ctool cns query --user "0x01a369998e4a141c5e2b40dbcbaf4a601d57cfa5" --pageNum "10" --pageSize "0"
  # 4 通过合约地址进行查询
  // 目前接口为通过地址查询未被注销的合约
  ctool cns query --contract "0x01a369998e4a141c5e2b40dbcbaf4a601d57cfa5"
  ```

* **输出结果**：

  ```bash
  cnsInfo对象:
  json<kInfo>{
    "name": ,
    "version": ,
    "address": ,
    "origin": ,
    "create_time": ,
    "enabled":
  }

  # 成功
  # 注：操作#1 #2 #3 #4具有结构相似的输出结果
  ## 结果示例
  result:
  {
    "code":0,
    "msg":"ok",
    "data":{
      "total":8,
      "contract":[
        {"name":"__sys_NodeManager",
        "version":"1.0.0.0",
        "address":"0xa94ad954e17606b8c254065c2317139f9cc593d0",
        ... ...,
        "origin":"0x01a369998e4a141c5e2b40dbcbaf4a601d57cfa5",
        "create_time":1556258758307,
        "enabled":false}
      ]
    }
  }

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：
    * `char *getRegisteredContracts(int pageNum, int pageSize) const`
    contract: `cnsManager`
    * `char *getRegisteredContractsByAddress(char *origin, int pageNum, int pageSize) const`
    contract: `cnsManager`
    * `char* getContractInfoByAddress(char *address) const`
    contract: `cnsManager`
    * `char *getHistoryContractsByName(char *name) const`
    contract: `cnsManager`

### 3.5 合约cns状态查询 cns state // 倾向使用state

* **描述**：通过查询键查询一个合约在cns平台中的注册状态，注册状态分为：注册中（返回true）或者已经注销（返回false）。
* **参数**：
  * 必选参数：

  ```param
  <contract>:         查询键，根据合约账户地址或合约账户名称进行查询

  // 未实现
  --addr <address>:   查询键，合约账户地址
  --name string:      查询键，合约在cns中注册的合约名称（返回结果唯一）
  ```

* **操作**：
  * 重构前：

  ``` bash
  # 查询合约地址是否注册
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'ifRegisteredByAddress' --param "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" --abi "~/PlatONE-Go/release/linux/conf/contracts/cnsManager.cpp.abi.json" --config "../config.json"
  # 查询合约名称是否被注册
  ctool invoke --addr "0x0000000000000000000000000000000000000011" --func 'ifRegisteredByName' --param "test" --abi "~/PlatONE-Go/release/linux/conf/contracts/cnsManager.cpp.abi.json" --config "../config.json"
  ```

  * 重构后：

  ```bash
  # 查询合约地址是否注册
  ctool cns state "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206"
  # 查询合约名称是否被注册
  ctool cns state "test"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 已注册
  result: the contract is registered in CNS
  ## 未注册
  result: the contract is not registered in CNS

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：
    * `int ifRegisteredByName(char *name) const`
    contract: `cnsManager`
    * `int ifRegisteredByAddress(char *address) const`
    contract: `cnsManager`
  * 只要被查询地址或名称有一个cns对象的enable字段是有效的，查询结果都为真（已注册）

## 4. 防火墙服务 fw

TODO:

* 防火墙相关术语学习，并修改相应描述（待完成）？？？
* 添加通过合约名称调用防火墙？TxType冲突，fwType&cnsType，是否能够改进？

特别说明：防火墙开启与关闭状态与防火墙规则写入无关联，即使防火墙处于关闭状态依旧可以对防火墙规则进行编写，但仅当防火墙状态为开启时，写入的规则才会生效。

### 4.1 防火墙开启 fw start*

* **描述**：对指定合约开启防火墙服务
* **参数**：
  * 必选参数：

  ```param
  <addres>:    （进行防火墙设置的）合约账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool fwInvoke --addr "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c" --func '__sys_FwOpen()' --config "../config.json"  
  ```

  * 重构后：

  ```bash
  ctool fw start "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: Operation Succeeded

  # 失败
  略
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func (s *StateDB)OpenFirewall(addr common.Address)`

### 4.2 防火墙关闭 fw stop*

* **描述**：对指定合约关闭防火墙服务
* **参数**：
  * 必选参数：

  ```param
  <addres>:    （进行防火墙设置的）合约账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool fwInvoke --addr "0x5855455df9d1b395332e3ae9b2efc4e18ad8755f" --func '__sys_FwClose()' --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool fw stop "0x5855455df9d1b395332e3ae9b2efc4e18ad8755f"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: Operation Succeeded

  # 失败
  同 4.1
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func (s *StateDB)CloseFirewall(addr common.Address)`

### 4.3 防火墙信息查询 fw query* // 倾向不使用status?

[//]: <来源：Dev/PlatONE-Workspace/doc/操作指南1.0.md>

* **描述**：通过查询键，查询指定合约的防火墙信息
* **参数**：
  * 必选参数：

  ```param
  <addres>:    查询键，通过合约账户地址进行查询（返回结果唯一）
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool fwInvoke --addr "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c" --func '__sys_FwStatus()' --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool fw query "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: {
    "ContractAddress":"0x08644ba5e0dd71d3d7cbb58913a099c2f3ca403f",
    "FwActive":true,
    "AcceptedList":[{
      "Addr":"0xffffffffffffffffffffffffffffffffffffffff",
      "FuncName":"getName"}
    ],
    "DeniedList":[{
      "Addr":"0x01a369998e4a141c5e2b40dbcbaf4a601d57cfa5",
      "FuncName":"invokeNotify"}
    ]
  }

  # 失败
  同 4.1
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：`func (s *StateDB) GetFwStatus(addr common.Address) FwStatus`

### 4.4 防火墙规则清空 fw clear

* **描述**：清空指定合约的防火墙的approve操作或reject操作的全部规则
* **参数**：
  * 必选参数：

  ```param
  <addres>:             （进行防火墙设置的）合约账户地址
  ```

  * 可选参数：

  ```param
  --action string       清除对应操作的防火墙规则。防火墙操作：允许approve(allow?)或拒绝reject(block?)
  --all                 清除所有操作的防火墙规则
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool fwInvoke --addr "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c" --func '__sys_FwClear("Reject")' --config "../config.json"
  ```

  * 重构后：

  ```bash
  # 清除对应防火墙操作规则
  ctool fw clear "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c" --action "Reject"
  # 清除所有防火墙规则
  ctool fw clear "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c" --all
  ```

* **输出结果**：

  ```bash
  # 成功
  result: Operation Succeeded

  # 失败
  同 4.1
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func (s *StateDB) FwClear(addr common.Address, action Action)`

### 4.5 防火墙规则添加 fw new

* **描述**：新建一条或多条指定合约的防火墙规则。一条防火墙规则包含具体的防火墙操作（accept或reject操作），需要进行过滤的账户地址以及需要进行限制访问的合约接口名。
* **参数**：
  * 必选参数：

  ```param
  <addrres>:             (进行防火墙设置的)合约账户地址
  <action>:             防火墙操作：允许accept(allow?)或拒绝reject(block?)
  <account>:            指定被过滤的一个或多个用户账户地址，'*'表示防火墙规则对所有用户账户地址生效。格式["<address1>","<address2>"]，单个账户地址可省略[]。
  <api>:                指定过滤的合约接口名，'*'表示该合约的所有接口。格式["<funcname1>","<funcname2>"]，单个接口名可省略[]。示例--api "getName"
  ```

  注：目前只支持单条防火墙规则的添加，即单个账户地址+单个接口

* **操作**：
  * 重构前：

  ```bash
  ctool fwInvoke --addr "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" --func '__sys_FwAdd("Accept","*:getName")' --config "../config.json"
  ctool fwInvoke --addr "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" --func '__sys_FwAdd("REJECT", "<addr1>:*|*:<api2>|<addr3>:<api3>")' --config "./config.json"
  ```

  * 重构后：

  ```bash
  ## 新增一条防火墙规则
  ctool fw "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" "accept" "*" "getName"

  ## 批量新增（暂未实现）
  ctool fw --addr "0x2ee8d0545ebd20f9a992ff54cb0f21a153539206" --act "reject" --user ["<addr1>,*,<addr3>"] --api ["*,<api2>,<api3>"]
  // 省去"__sys_FwAdd"的填写
  // --acount --api分开的写法对用户不太友好？
  ```

* **输出结果**：

  ```bash
  # 成功
  result: Operation Succeeded

  # 失败
  同 4.1
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func (s *StateDB) FwAdd(addr common.Address, action Action, list []FwElem)`

### 4.6 防火墙规则删除 fw delete

* **描述**：删除一条指定合约的防火墙规则。
* **参数**：
  * 必选参数：

  ```param
  <addres>:               （进行防火墙设置的）合约账户地址
  <action>:               防火墙操作：允许approve(allow?)或拒绝reject(block?)
  <account>:              指定被过滤的一个或多个用户账户地址，'*'表示防火墙规则对所有用户账户地址生效。格式["<address1>","<address2>"]，单个账户地址可省略[]。
  <api>:                  指定过滤的合约接口名，'*'表示该合约的所有接口。格式["<funcname1>","<funcname2>"]，单个接口名可省略[]。示例--api "getName"
  ```
  
  注：目前只支持单条防火墙规则的删除，即单个账户地址+单个接口

* **操作**：
  * 重构前：

  ``` bash
  ctool fwInvoke --addr "0x5855455df9d1b395332e3ae9b2efc4e18ad8755f" --func '__sys_FwDel("Reject","0x01a369998e4a141c5e2b40dbcbaf4a601d57cfa5:setName")' --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool fw delete "0x5855455df9d1b395332e3ae9b2efc4e18ad8755f" "Reject" "0x01a369998e4a141c5e2b40dbcbaf4a601d57cfa5" "setName"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: Operation Succeeded

  # 失败
  同 4.1
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func (s *StateDB) FwDel(addr common.Address, action Action, list []FwElem)`

### 4.7 防火墙规则替换 fw reset

* **描述**：将指定合约的防火墙accept操作或者reject操作对应的所有规则清空，并再写入成一条对应操作的新的规则。
* **参数**：
  * 必选参数：

  ```param
  <addres>:               （进行防火墙设置的）合约账户地址
  <action>:               防火墙操作：允许accept(allow?)或拒绝reject(block?)
  <account>:              指定被过滤的一个或多个用户账户地址，'*'表示防火墙规则对所有用户账户地址生效。格式["<address1>","<address2>"]，单个账户地址可省略[]。
  <api>:                  指定过滤的合约接口名，'*'表示该合约的所有接口。格式["<funcname1>","<funcname2>"]，单个接口名可省略[]。示例--api "getName"
  ```

  注：目前只支持单条防火墙规则的重置，即单个账户地址+单个接口

* **操作**：
  * 重构前：

  ``` bash
  ctool fwInvoke --addr "0x5855455df9d1b395332e3ae9b2efc4e18ad8755f" --func '__sys_FwSet("Reject","*:setName")' --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool fw replace "0x5855455df9d1b395332e3ae9b2efc4e 18ad8755f" "Reject" "*" "setName"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: Operation Succeeded

  # 失败
  同 4.1
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func (s *StateDB) FwSet(addr common.Address, action Action, list []FwElem)`

### 4.8 防火墙规则导入 fw import // import rule list

* **描述**：将XX格式防火墙文件中的防火墙规则导入指定合约的防火墙规则中
* **参数**：
  * 必选参数：

  ```param
  --addr <addres>:     （进行防火墙设置的）合约账户地址
  ```

  * 可选参数：

  ```param
  --fwfile <file>:      导入的防火墙规则文件的路径，默认文件为。/config/fireWall.json
  ```

* **操作**：
  * 重构前：

  ``` bash
  略
  ```

  * 重构后：

  ```bash
  ctool fw import "0x5855455df9d1b395332e3ae9b2efc4e18ad8755f" --fwfile <file path>
  ```

* **输出结果**：

  ```bash
  # 成功
  result: Operation Succeeded

  # 失败
  同 4.1
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`func (s *StateDB) FwImport(addr common.Address, data []byte) error`

### 4.9 防火墙规则导出 fw export

* **描述**：将指定合约的防火墙规则导出到指定位置的防火墙规则文件中
* **参数**：
  * 必选参数：

  ```param
  <addres>:             合约账户地址
  ```

  * 可选参数：

  ```param
  --fwfile <file>:      导出的防火墙规则文件存储的路径，默认路径为./config
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool fwInvoke --addr "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c" --func '__sys_FwStatus()' --config "../config.json"
  // 通过__sys_FwStatus()实现，没有独立的接口
  ```

  * 重构后：

  ```bash
  # 导出防火墙规则到默认地址
  ctool fw export "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c"

  # 导出防火墙规则到指定地址
  ctool fw export "0xacda4dfbbd6d093cf7e348abb33296d9aeb0f23c" --fwfile <file path>
  ```

* **输出结果**：
同 4.3

* **备注**：

## 5. 系统管理员 admin

* **分类依据**：
  * 根据目前PlatONE已有的角色进行分类,方便各类管理员使用符合各自权限的命令。例如节点管理员只需在node二级命令中去寻找相关命令，从而减少调用一个操作发现no permission的情况。
  * 虽然node, ,user,这些二级命令的子命令重合度很高，但是同名子命令的必要参数却不一致，也导致无法将这些命令较好的合并到一起。
* **补充**：
  * 二级命令的名称参考了PlatONE权限模型中的角色命名

### 5.1 节点管理员 admin node

#### 5.1.1 节点添加 admin node add

[//]: <来源：Dev/PlatONE-Workspace/doc/操作指南1.0.md>

* **描述**：将节点添加到PlatONE网络中。没有被管理员添加到节点列表的节点无法参与PlatONE网络中节点的区块同步，共识等等。第一次被添加的节点类型都为观察者节点。观察者节点后续可以由管理员修改成为共识节点参与共识。（节点被添加后，在下一次peer更新时会与PlatONE网络中的boostnode节点建立连接（待确认））

  **注**：
  * 如果节点列表中已有同名且状态为有效的节点，则注册失败。
  * 如果节点列表中已有同公钥的节点（无论节点状态），则注册失败。

* **参数**：
  * 必选参数：

  ```param
  <name>:            节点名称
  <publicKey>:       节点公钥，用于节点间安全通信。节点的公私钥对可由ethkey工具产生。
  <externalIP>:      节点外网IP
  <internalIP>:      节点内网IP


  // 初始化时都是固定常数值，可以省略
  // --type string:      节点类型，0为观察者节点，1为共识节点。初次加入链网络的节点都为观察节点，观察节点可以由管理员设置为共识节点。
  // --status string:    节点状态，1为有效状态，2为无效（删除）状态
  ```

  * 可选参数：

  ```param
  --rpc-port int<num>:  用于rpc远程调用的网络端口，默认端口6791
  --p2p-port int<num>:  用于p2p通信的网络端口，默认端口16791
  --desc string:        节点描述
  --delay <num>:        共识节点延迟设置的区块高度，默认实时设置

  // 简写--rpc, --p2p ???
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool invoke --addr "0x7b821b3d871426eb79d6e7145126f7d0b5fb4356" --func 'add' --param '{"name":"root","owner":"0x96307a6168921cefd50d66e1921a029fe1982394","approver":"0x96307a6168921cefd50d66e1921a029fe1982394","desc":"root","publicKey":"feffe2938d427088f5fcce94a9245760b92c468d3ca25ab5ef2b1cdccf0ed911963b74ca2dffef20ef135966e34ebcc905d1f12c1df09f05974a617cf8afe8e8","root":true,"type":1,"externalIP":"127.0.0.1","internalIP":"127.0.0.1","rpcPort":6791,"p2pPort":16791,"status":1}' --abi "./conf/contracts/nodeManager.cpp.abi.json" --config "./user2.json"
  ```

  * 重构后：

  ```bash
  ctool admin node add "root" --desc "root" "feffe2938d427088f5fcce94a9245760b92c468d3ca25ab5ef2b1cdccf0ed911963b74ca2dffef20ef135966e34ebcc905d1f12c1df09f05974a617cf8afe8e8" "127.0.0.1" "127.0.0.1"
  // 不需指定type, status
  // owner 需要指定，目前内置一个值
  // approver不需要指定，已弃用？
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步结果
  result：add node info success. node info: {"delayNum":... ...}

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int add(const char *nodeJsonStr)`
  contract: `nodeManager`
  * `"owner"``"approver"`字段未启用

#### 5.1.2 节点删除 admin node delete

* **描述**：将节点从节点列表中删除。在下一次peers更新后，被删除的节点会被PlatONE网络中的其他节点断开连接。
* **参数**：
  * 必选参数：

  ```param
  <name>:        节点名称
  ```

* **操作**：
  * 重构前：

  ``` bash
  略
  ```

  * 重构后：

  ```bash
  ctool admin node delete "root"
  // 不存在用户直接修改status的情况。确保status只能从1->2。
  // 状态修改后，节点的完整信息依旧可以通过query命令查询到
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 写操作
  result: NodeManager update key: status

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int update(const char *name, const char *nodeJsonStr)`
  contract `nodeManager`

#### 5.1.3 节点信息更新 admin node update 只更新用户邮箱和电话信息，设计的意义不大？

[//]: <来源：PlatONE_WIKI/zh-cn/use/Installation/详细安装与启动.md>

* **描述**：
  * 更新节点的`desc`、`delayNum`与`type`字段中的信息。无法更新权限同级及其以上角色节的信息。
  * 状态无效的节点依旧可以更新相应信息(bug?)
* **参数**：
  * 必选参数：

  ```param
  <name>:            节点名称
  ```

  * 可选参数：

  ```param
  --desc string:     节点描述
  --type string:     节点类型，"observer"(0)为观察者节点，"consensus"(1)为共识节点。
  --delay <num>:     共识节点延迟设置的区块高度，默认实时设置
  ```

* **操作**：
  * 重构前：

  ``` bash
  # 通过系统合约地址进行调用
  ctool invoke --addr "0x7b821b3d871426eb79d6e7145126f7d0b5fb4356" --func "update" --param "nodeC" --param '{"type":1}' --abi "./conf/contracts/nodeManager.cpp.abi.json" --config "./user2.json"
  # 通过系统合约名称进行调用
  ctool cnsInvoke --cns "__sys_NodeManager"   --config "ctool.json" --abi "nodeManager/nodeManager.cpp.abi.json" --func "update" --param "test" --param '{"type":1}'

  ctool cnsInvoke --cns "__sys_NodeManager" --func 'update("node-4","1")' --abi "~/PlatONE-Go/release/linux/conf/contracts/nodeManager.cpp.abi.json" --config "../config.json"
  // 建议使用合约名称调用系统合约
  ```

  * 重构后：

  ```bash
  # 更新节点type信息
  ctool admin node update "node-4" --type "consensus"
  # 更新节点desc信息
  ctool admin node update "node-4" --desc "this is a description"
    # 更新节点delayNum信息
  ctool admin node update "node-4" --delay 10
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步查询
  result: NodeManager update key: type

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int update(const char *name, const char *nodeJsonStr)`
  contract: `nodeManager`

#### 5.1.4 节点信息查询 admin node query

[//]: <来源：PlatONE_WIKI/zh-cn/use/Installation/详细安装与启动.md>

* **描述**：通过查询键对节点信息进行查询，返回匹配成功的数据对象。
* **参数**：
  * 可选参数：

  ```param
  若无任何查询键则返回网络中所有节点的数据对象
  --all                 查询键，查询所有节点(包含已被删除的节点)
  --name string：       查询键，通过节点名称进行查询（返回结果可能不唯一）
  --status string:      查询键，通过节点状态进行查询。valid(1)为有效状态，invalid(2)为无效（删除）状态
  --type string:        查询键，通过节点类型进行查询。observer(0)为观察者节点，consensus(1)为共识节点
  --publickey string:   查询键，通过节点公钥进行查询（返回结果唯一）

  // 暂未实现
  --enode               搭配--status使用，返回的节点信息为enode格式
  ```

* **操作**：
  * 重构前：

  ``` bash
  # 通过系统合约地址进行调用
  ## 返回网络中所有节点
  ctool invoke --addr "0x7b821b3d871426eb79d6e7145126f7d0b5fb4356" --func 'getAllNodes' --abi "./conf/contracts/nodeManager.cpp.abi.json" --config "./user2.json"
  ## 根据查询键进行搜索
  ctool invoke --addr "0x7b821b3d871426eb79d6e7145126f7d0b5fb4356" --func 'getNodes' --param '{"name":"nodeC"}' --abi "./conf/contracts/nodeManager.cpp.abi.json" --config "./user2.json"

  # 通过系统合约名称进行调用
  ## 返回网络中所有节点
  ctool cnsInvoke --cns "__sys_NodeManager"   --config "ctool.json" --abi "nodeManager/nodeManager.cpp.abi.json" --func "getAllNodes()"
  ## 根据查询键进搜索
  ctool cnsInvoke --cns "__sys_NodeManager" --func 'getNodes({"name":"node-0"})' --abi "~/PlatONE-Go/release/linux/conf/contracts/nodeManager.cpp.abi.json" --config "../config.json"
  ```

  * 重构后：

  ```bash
  ## 返回网络中所有节点
  ctool admin node query --all
  ## 根据查询键进行搜索
  ctool admin node query --name "node-0"

  ctool admin node query --status "valid"

  ctool admin node query --type "consensus"

  ## 组合查询
    ctool admin node query --status "valid" --name "root"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 读操作
  * result: %s

  ## 示例
  array of json<nodeInfo>
  result:{
    "code":0,
    "msg":"success",
    "data":[{
      "name": ...,
      "owner": ...,
      "desc": ...,
      "type": ...,
      "publickey": ...,
      "externalIP": ...,
      "internalIP": ...,
      "rpcPort": ...,
      "p2pPort": ...,
      "status": ...,
      "delynum": `omitempty`
      }
    ]
  }
  // 无"approver"字段

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：
    * `const char *getAllNodes() const`
    contract: `nodeManager`
    * `const char *getNodes(const char *nodeJsonStr) const`
    contract: `nodeManager`
    * `nodeManager: getNormalEnodeNodes`
    * `nodeManager: getDeletedEnodeNodes`
    // 返回 `enode://<pk>@<int-ip>:<p2p-port>|...|enode:...`

#### 5.1.4 节点信息统计 admin node stat

[//]: <来源：Dev/PlatONE-Workspace/doc/操作指南1.0.md>

* **描述**：通过查询键对节点信息进行查询，对匹配成功的数据对象进行统计，返回统计值。
* **参数**：
  * 可选参数：

  ```param
  --status string:    查询键，通过节点状态进行统计。"valid"为有效状态(1)，"invalid"为无效（删除）状态(2)
  --type string:      查询键，通过节点类型进行统计。"observer"为观察者节点(0)，"consensus"为共识节点(1)
  ```

  * 无意义的参数：(暂未实现)

  ```param
  --name string：       查询键，通过节点名称进行统计 // 包含无效状态节点的名称的统计，无意义？
  --pk string:          查询键，通过节点公钥进行统计（返回结果唯一） //删除 返回值只能为1
  ```

* **操作**：
  * 重构前：

  ``` bash
  # 指定公钥对应的有效节点数目
  ctool invoke --addr "0x743bc6816b2fa897d60b657b7eee3aaf2e3ca253" --func 'getRegisterInfoByPublicKey' --param "7caae651e633769fa693f633e3a468775bf19699ccdc014eb9449c2eb0f82ebde4a7d28c9b846d2df02d1e7f7e1460fbb31eb83c6faf208dcbfd4f2944d31c61" --abi "./conf/contracts/nodeRegister.cpp.abi.json" --config "./user2.json"
  ```

  * 重构后：

  ```bash
  # 指定公钥对应的节点数目
  ctool admin node stat --status "valid"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 读操作
  * result: <num>

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：
    `int nodesNum(const char *nodeJsonStr) const`
    contract: `nodeManager` 调用getNodes
    `int validJoinNode(const char *publicKey) const`
    contract: `nodeManager` 调用nodesNum

### 5.2 合约部署者管理员 admin contract*

#### 5.2.1 合约部署者审核 admin contract approve

* **描述**：审核审核中状态的合约部署者角色的注册信息，并给予通过或是拒绝操作。
* **参数**：
  * 必选参数：

  ```param
  <address>:        角色注册表中注册合约部署者用户的账户地址
  <operation>:      审批状态: approve(2)为注册申请通过，reject(3)为拒绝
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_RoleRegister" --func 'approveRole("0xb239401ecf8427f17c6de134d6a6bddd3100251f",2)'  --abi "~/PlatONE-Go/release/linux/conf/contracts/roleRegister.cpp.abi.json" --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool admin contract approve "0xb239401ecf8427f17c6de134d6a6bddd3100251f" "approve"
  ```

* **输出结果**：

  ```bash
  # 成功
  // TODO

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int approveRole(const char* address, int status)`
  contract: `roleRegister`

#### 5.2.2 合约部署者添加 admin contract add

// 是否会检查角色注册表信息？

* **描述**：为一个有效用户添加合约部署者角色，添加成功后该用户可以进行合约部署操作，并可以对自己部署的合约进行迁移和写操作。
* **参数**：
  * 必选参数：

  ```param
  <name>:         被添加合约部署者角色的用户账户名称
  <address>:      被添加合约部署者角色的用户账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  略
  ```

  * 重构后：

  ```bash
  ctool admin contract add "0xb239401ecf8427f17c6de134d6a6bddd3100251f" "root"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: OK: [RoleManager] [addRole] Update roles success. \
  address: 0xb239401ecf8427f17c6de134d6a6bddd3100251f, roles: ["contractDeployer"]

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int addRole(const char *name, const char *address, const char *roles)`
  contract: `roleManager`

#### 5.2.3 合约部署者删除 admin contract delete

* **描述**：删除用户的合约部署者角色，成功删除后该用户无法再进行合约部署、写操作以及迁移操作。
* **参数**：
  * 必选参数：

  ```param
  <address>:      删除合约部署者角色的用户的账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_RoleManager" --func 'removeRole("0x08e7988e60ab5aa49d1f7aa9435ac91b9fcf772c","["contractDeployer"]")' --abi "~/PlatONE-Go/release/linux/conf/contracts/roleManager.cpp.abi.json" --config "../config.json"
  ```

  * 重构后：

  ```bash
  ctool admin contract delete "0x08e7988e60ab5aa49d1f7aa9435ac91b9fcf772c"
  ```

* **输出结果**：

  ```bash
  # 成功
  result: OK: [RoleManager] [removeRole] Remove roles success. \
  address: 0xb239401ecf8427f17c6de134d6a6bddd3100251f, roles: ["contractDeployer"]

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int removeRole(const char *address,const char *roles)` `roleManager`

#### 5.2.4 部署合约审计 admin contract audit // 暂无接口

略

#### 5.2.5 合约部署者请求列表 admin contract list*

* **描述**：根据不同操作，返回满足筛选条件的合约部署者用户列表。
* **参数**：
  * 可选参数：

  ```param
  --approve         获取审核中的注册合约部署角色的列表
  --delete          获取拥有合约部署者角色的用户列表

  // 未实现
  --display <num>   x
  --index <num>     x
  ```

* **操作**：
  * 重构前：

  ``` bash
  # 拥有合约部署者角色的用户列表
  ctool invoke --addr "0x1df9e46ccaf981f993fe26a6eb52a6c3fd7193df" --func 'getAccountsByRole' --param "chainAdmin" --abi "roleManager/roleManager.cpp.abi.json" --config "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  # 拥有合约部署者角色的用户列表，方便删除delete操作
  ctool admin contract list --delete
  // 等价于 ctool account query --roles ["contractDeployer"]

  # 角色注册表中审核中状态的用户，方便审核approve操作
  ctool admin contract list --approve
  // 等价于ctool account query --status "1" --reg "role" --display "10" --index "2"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## delete操作
  result:
  {
    "code": 0,
    "msg": "Success",
    "data": [{
        "name": "root"
        "address": "0x......"
    }]
  }

  ## approve操作
  ### 无申请用户
  result: no contractDeployer in registration
  ### 有申请用户
  result:
  {
    "code": 0,
    "msg": "ok",
    "data": [{
        "approver": "",
        "requireRoles": ["nodeAdmin", "contractDeployer"],
        "roleRequireStatus": 1,
        "userName": "root",
        "userAddress": "0x......"
    }]
  }

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：
    `const char* getAccountsByRole(const char *role) const`
    contract: `roleManager`
    待补充

### 5.3 用户管理员 admin user

#### 5.3.1 用户审核 admin user approve

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：对用户注册表审核中状态的用户进行审核，通过或拒绝该注册申请并修改相应的申请状态。若状态为通过，用户注册成功，在用户平台中可以查到相应用户信息。
* **参数**：
  * 必选参数：

  ```param
  --addr <address>:       用户注册表中的账户地址
  --status int<num>:      审批状态: "approve"为注册审批通过(2)，"reject"为拒绝(3)
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_UserRegister" --func 'approve("0xb239401ecf8427f17c6de134d6a6bddd3100251f",2)' --abi "~/PlatONE-Go/release/linux/conf/contracts/userRegister.cpp.abi.json" --config  "../config.json"

  ctool invoke --addr "0xf7e769f67be5bf06d5712c355e293ef0d4c685fc" --func 'approve' --param '0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe' --param "2" --abi "./userRegister/userRegister.cpp.abi.json" --config  "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  ctool admin user approve '0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe' "approve"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 写操作
  (待补充)

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int approve(const char* userAddress, int auditStatus)`
  contract: `userRegister`

#### 5.3.2 用户添加 admin user add

* **描述**：主动添加一个账户到用户平台。
* **参数**：
  * 必选参数：

  ```param
  <address>：       用户账户地址
  <name>：          用户账户名
  <tel>：           用户电话信息  
  <email>：         用户邮箱信息
  ```

* **操作**：

  * 重构前：

  ``` bash
  略
  ```

  * 重构后：

  ```bash
  ctool admin user add "0xb239401ecf8427f17c6de134d6a6bddd3100251f" "Alice" "13111111111" "alice@wx.bc.com"
  ```

* **输出结果**：

  ```bash
  # 成功
  (待补充)

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int addUser(const char* userJson)`
  contract: `userManager`

#### 5.3.3 用户删除 admin user delete

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：删除一个用户，被删除的用户无法使用其拥有角色的权限。拥有chainCreator角色的用户无法被删除。（用户被删除后，其对应的账户地址无法再次进行用户注册(待确认))）。
* **参数**：
  * 必选参数：
  
  ```param
  <address>:   删除用户的账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_UserManager" --func 'delUser("0xb239401ecf8427f17c6de134d6a6bddd3100251f")' --abi "~/PlatONE-Go/release/linux/conf/contracts/userManager.cpp.abi.json" --config "../config.json"

  ctool invoke --addr "0x6c990c0f1ae07222c7b7dcb2b68b936d0008ca57" --func 'delUser' --param "0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe" --abi "userManager/userManager.cpp.abi.json" --config "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  ctool admin user delete "0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步查询
  result: Operation Succeeded

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int delUser(const char* userAddr)`
  contract：`userManager`

#### 5.3.4 用户解禁 admin user enable

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：将用户从禁用状态改为有效状态，该用户相应角色的权限也随之恢复。
* **参数**：
  * 必选参数：
  
  ```param
  <address>:   解禁用户的账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_UserManager" --func 'enable("0xb239401ecf8427f17c6de134d6a6bddd3100251f")' --abi "~/PlatONE-Go/release/linux/conf/contracts/userManager.cpp.abi.json" --config "../config.json"

  ctool invoke --addr "0x6c990c0f1ae07222c7b7dcb2b68b936d0008ca57" --func 'enable' --param "0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe" --abi "userManager/userManager.cpp.abi.json" --config "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  ctool admin user enable "0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步查询
  result: 用户状态更新成功

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int enable(const char* userAddr)` `userManager`

#### 5.3.5 用户禁用 admin user disable

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：禁用某个用户，被禁用的用户无法使用其角色对应的权限，但不影响其发送交易。拥有chainCreator角色的用户无法被禁用。
* **参数**：
  * 必选参数：
  
  ```param
  <address>:   禁用用户的账户地址
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_UserManager" --func 'disable("0xb239401ecf8427f17c6de134d6a6bddd3100251f")' --abi "~/PlatONE-Go/release/linux/conf/contracts/userManager.cpp.abi.json" --config "../config.json"

  ctool invoke --addr "0x6c990c0f1ae07222c7b7dcb2b68b936d0008ca57" --func 'disable' --param "0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe" --abi "userManager/userManager.cpp.abi.json" --config "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  ctool admin user disable "0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 同步查询
  result: Operation Succeeded

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_sendTransaction`
  * 对应方法：`int disable(const char* userAddr)`
  contract: `userManager`

#### 5.3.6 用户(信息)更新 admin user update

* **描述**：更新用户绑定的电话或者邮箱信息。拥有chainCreator角色的用户（超级管理员）可以更新所有用户的信息，有角色的权限用户仅可以更新无权限用户的信息。
//设计的意义？如果只是修改电话号码和邮箱感觉对于管理者来说意义不大？？

详见Section 1.4

#### 5.3.7 用户请求列表 admin user list*

* **描述**：根据管理员不同的操作，返回满足筛选条件的用户列表或者用户注册列表。例如，输入用户审核操作，则返回用户注册表审核中的用户注册信息。
* **参数**：

  * 可选参数：

  ```param
  --approve         获取审核中状态的注册用户列表

  // 暂未实现
  --delete          获取可删除的用户列表
  --enable          获取当前有效状态的用户列表
  --disable         获取禁用状态的用户列表
  --display <num>:  x
  --index <num>:    x
  ```

* **操作**：
  * 重构前：

  ``` bash
  无
  ```

  * 重构后：

  ```bash
  # 显示用户平台用户（无接口，暂未实现）
  ctool admin user list --enable --display "10" --index "2"
  // 等价于ctool account query --status "1" --display "10" --index "2"

  # 显示被禁用用户（无接口，暂未实现）
  ctool admin user list --disable --display "10" --index "2"
  // 等价于ctool account query --status "2" --display "10" --index "2"

  # 显示用户注册表审核中用户
  ctool admin user list --approve
  // 等价于ctool account query --status "1" --reg "user" --display "10" --index "2"
  ```

* **输出结果**：

  ```bash
  # 成功
  ## 无用户申请
  result:
  {
    "code": 3,
    "msg": "user information is empty in the UserRegister",
    "data":""
  }

  # 失败
  同 2.3
  ```

* **备注**：
  * 调用RPC接口：`eth_call`
  * 对应方法：
    待补充

### 5.4 XX管理员 admin sup*

#### 5.4.1 XX审核 admin sup approve

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：审核有效用户审核中状态注册角色的申请，给予通过或拒绝，并修改注册表中相应字段的状态信息。审核通过的角色会添加到对应用户中，（在下一次共识后）该用户可以使用相应的权限。
* **参数**：
  * 必选参数：

  ```param
  --addr <address>:       角色注册表中的用户账户地址
  --status int<num>:      审批状态: approve(2)为注册申请通过，reject(3)为拒绝
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_RoleRegister" --func 'approveRole("0xb239401ecf8427f17c6de134d6a6bddd3100251f",2)'  --abi "~/PlatONE-Go/release/linux/conf/contracts/roleRegister.cpp.abi.json" --config "../config.json"

  ctool invoke --addr "0xf8f1bec07e2556e6be2371f441f0a1ce9c8b737b" --func 'approveRole' --param '0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe' --param 2 --abi "roleRegister/roleRegister.cpp.abi.json" --config "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  ctool admin sup approve "0xb239401ecf8427f17c6de134d6a6bddd3100251f" "approve"
  ```

* **输出结果**：

  ```bash
  # 成功
  (待补充)

  # 失败
  同 2.3
  ```

* **备注**：

#### 5.4.2 XX添加 admin sup add

* **描述**：添加一个或多个角色到有效用户的角色列表中，添加成功（在下一次共识后，）该用户拥有对应角色权限。XX只能添加低于自身角色权限的角色给其他用户。
// 一个用户拥有多个角色的模式有一点奇怪？详细解释理由。<font color=#DC143C>角色权限是有重叠的，产生什么问题？在检查管理者权限时，进行遍历？</font>
* **参数**：
  * 必选参数：

  ```param
  <address>:          添加角色的用户的账户地址
  <roles>:            添加的一个或多个角色名，格式为"["<role>"]"或者"["<role1>",...,"<role3>"]"
  ```

* **操作**：
  * 重构前：

  ``` bash
  #
  ```

  * 重构后：

  ```bash
  ctool admin sup add "0x08e7988e60ab5aa49d1f7aa9435ac91b9fcf772c" '["nodeAdmin","contractDeployer"]'
  ```

* **输出结果**：

  ```bash
  # 成功
  同 5.2.2

  # 失败
  同 2.3
  ```

* **备注**：

#### 5.4.3 XX删除 admin sup delete

[//]: <来源：Dev/PlatONE-Workspace/doc/功能演示.md>

* **描述**：删除用户的一个或多个角色，（在下一次共识后，）该用户失去相应角色的权限。
* **参数**：
  * 必选参数：

  ```param
  <address>:      添加角色的用户的账户地址
  <roles>:        删除的一个或多个角色名，格式为"["<role>"]"或者"["<role1>",...,"<role3>"]"
  ```

* **操作**：
  * 重构前：

  ``` bash
  ctool cnsInvoke --cns "__sys_RoleManager" --func 'removeRole("0x08e7988e60ab5aa49d1f7aa9435ac91b9fcf772c","["nodeAdmin"]")' --abi "~/PlatONE-Go/release/linux/conf/contracts/roleManager.cpp.abi.json" --config "../config.json"

  ctool invoke --addr "0x1df9e46ccaf981f993fe26a6eb52a6c3fd7193df" --func 'removeRole' --param "0x39f5ddcd8956e57b7fe6290e008f845f59dde8fe" --param '["nodeAdmin"]' --abi "roleManager/roleManager.cpp.abi.json" --config "cnsManager/config.json"
  ```

  * 重构后：

  ```bash
  ctool admin sup delete "0x08e7988e60ab5aa49d1f7aa9435ac91b9fcf772c" "['nodeAdmin']"
  ```

* **输出结果**：

  ```bash
  # 成功
  同 5.2.3

  # 失败
  同 2.3
  ```

* **备注**：

#### 5.4.4 XX请求列表 admin sup list*

* **描述**：根据管理员不同的操作，返回满足筛选条件的用户角色列表或者用户角色注册列表。例如，输入审核操作，则返回用户角色注册表审核中的角色注册信息。

详细参考 5.2.5

### 5.5 系统参数设置 admin sysconfig (暂未实现)

[//]: <来源：/PlatONE-Workspace/doc/操作指南1.0.md>

#### 5.5.1 共识设置 admin sysconfig consensus*

```bash
ctool cnsInvoke --cns "__sys_ParamManager" --func 'setBlockGasLimit("10000000000000000")' --abi "paramManager/paramManager.cpp.abi.json" --config "cnsManager/config.json"
```

#### 5.5.2 权限控制设置 admin sysconfig ac*

#### 5.5.3 服务费设置 admin sysconfig gasfee*

```bash
ctool cnsInvoke --cns "__sys_ParamManager" --func 'setTxGasLimit("5000000000000")' --abi "paramManager/paramManager.cpp.abi.json" --config "cnsManager/config.json"
```

## A. PlatONE系统合约中未使用的接口 (待补充)

## B. 参考来源

[1] [Dev/PlatONE-Workspace/doc/功能演示.md](https://172.16.211.192/PlatONE/doc/Dev/blob/develop/PlatONE-Workspace/doc/%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA.md)

[2] [Dev/PlatONE-Workspace/doc/操作指南1.0.md](https://172.16.211.192/PlatONE/doc/Dev/blob/develop/PlatONE-Workspace/doc/%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%971.0.md)

[3] [Dev/PlatONE-Workspace/doc/PlatONE-Authority-Management-Tutorial.md](https://172.16.211.192/PlatONE/doc/Dev/blob/develop/PlatONE-Workspace/doc/PlatONE-Authority-Management-Tutorial.md)
