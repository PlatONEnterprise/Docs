# PlatONE快速部署

## 1. PlatONE源码下载及编译

首先用户需要从github下载PlatONE源码并编译

```shell
# 获取PlatONE源码
git clone --recursive https://github.com/PlatONEnterprise/PlatONE-Go.git
export WORKSPACE=${PWD}/PlatONE-Go/release/linux

# 编译PlatONE
cd PlatONE-Go; make all; cd ..
```

如果编译失败，请确保您正确安装了所需的环境，然后重新尝试.

## 2. 单机部署（适用于简单测试环境）

### 2.1 快速部署（适用于简单测试环境）

本节将介绍如何快速启动一个节点或在同一台机器中启动四个节点。

#### 2.1.1 开启单节点

快速启动单节点区块链:

```bash
./platonectl.sh one
```

#### 2.1.2 开启四节点

在一台机器上快速启动四节点区块链:

```bash
./platonectl.sh four
```

### 2.2 快速演示

#### 2.2.1 启动单节点区块链

```shell
# 1. 生成描述区块链信息的genesis文件
cd ${WORKSPACE}/scripts
./platonectl.sh setupgen -n 0 --ip 127.0.0.1 --p2p_port 16791 --auto true  

# 2. 初始化第一个节点(node 0)
./platonectl.sh init -n 0 --ip 127.0.0.1 --rpc_port 6791 --p2p_port 16791 \
--ws_port 26791 --auto "true"

# 3. 开启节点 (node 0)
./platonectl.sh start -n 0

# 4. 部署系统合约
./platonectl.sh deploysys -n 0  --auto "true"
```

#### 2.2.2 将其他节点添加到链中

```shell
# 1. 初始化node-1
./platonectl.sh init -n 1 --ip 127.0.0.1 --rpc_port 6792 --p2p_port 16792 \
--ws_port 26792 --auto "true"

# 2. 启动node-1
./platonectl.sh start -n 1

# 3. 将节点添加到已存在的区块链中
./platonectl.sh addnode -n 1 

# 4. 将node-1更新为共识节点
./platonectl.sh updatesys -n 1
```

### 2.3 链部署详细

#### 2.3.1 创建genesis.json

当您启动区块链时，首先需要创建genesis.json文件。

```
cd ${WORKSPACE}/scripts
./platonectl.sh setupgen -n 0 --ip 127.0.0.1 --p2p_port 16791 --auto true  
```

* auto=false: 将给出提示进行选择是否编译系统合约

您也可以使用默认值。

```
./platonectl.sh setupgen
```

#### 2.3.2 初始化节点

```
./platonectl.sh init -n 0 --ip 127.0.0.1 --rpc_port 6791 --p2p_port 16791 \
--ws_port 26791 --auto "true"
```

您也可以使用默认值。

```bash
./platonectl.sh init
```

#### 2.3.3 启动节点

```bash
./platonectl.sh start -n 0
```

在启动节点时, 也可以指定日志文件夹的路径, 日志文件分块的大小, 指定platone启动时额外的命令行参数等. (注意: 路径连接符'/' 需要进行转义, 参数option的值, 必须加上引号)

```bash
./platonectl.sh start -n 0 -d '.\/logs\/platone' -s 65535 -e '--verbosity 3 --debug'
```

日志文件夹中包含wasm执行的日志与platone运行的日志. 随时间推移, 日志文件会越积越多, 建议进行挂载, 或者进行定期删除等操作。

#### 2.3.4 部署系统合约

```bash
./platonectl.sh deploysys -n 0 --auto true
```

#### 2.3.5 添加节点

您可能希望向PlatONE网络添加一些节点，您必须首先初始化此新节点。

* 初始化新节点(node 1):

```bash
./platonectl.sh init -n 1 --ip 127.0.0.1 --rpc_port 6792 --p2p_port 16792 \
--ws_port 26792 --auto "true"
```

* 增加新节点:

```bash
./platonectl.sh addnode -n 1
```

* 您也可以添加远程节点:

```bash
./platonectl.sh addnode -n 10 --p2p_port 3333 --rpc_port 4444 --ip xxx.xxx.xxx.xxx --pubkey xxxxx
```

#### 2.3.6 更新节点

将节点更新为共识节点。

```bash
./platonectl.sh updatesys -n 1
```

您还可以更新节点状态：

```bash
./platonectl.sh updatesys -n 1 -c '{"status":3}'
```

#### 2.3.7 创建账户

为节点创建帐户:

```bash
./platonectl.sh createacc -n 1
```

#### 2.3.8 解锁帐户

解锁节点帐户。 在解锁节点帐户之前，请确保已启动节点。

```bash
./platonectl.sh unlock -n 1
```

#### 2.3.9 连接到console

您可以打开一个交互式JavaScript环境 :

```bash
./platonectl.sh console -n 0
```

#### 2.3.10 获取所有节点

您可以从系统合约中获取所有节点

```bash
./platonectl.sh get
```

#### 2.3.11 查看节点信息

以下命令可用于获取节点状态和信息:

```bash
./platonectl.sh status -n 0
```

console:

```console
disable -> node_id:  0
          node info:
                  node.address: f92f1c1469d1a8c38964c63d62d3167842ce70cd
                  node.ip: 127.0.0.1
                  node.rpc_port: 6791
                  node.p2p_port: 16791
                  node.ws_port: 26791
                  node.pubkey: 9afcb45d2725059a5a6a7f379d6404b6c914b02dd3e7a33d29c87b3f28f8f63b78ffe2736a3cb52ae45bbf57471d438eac71ddcc0bdfbaa56d65e59d457159b2
```

#### 2.3.12 停止和清除

您可以停止节点并清除节点数据：

```bash
./platonectl.sh stop -n 0
./platonectl.sh clear -n 0
```

它还可以简化如下:(清除包括暂停功能）:

```bash
./platonectl.sh clear -n 0
```

## 3. 多机部署（适用于生产环境/多机测试环境）

案例:  A, B, C, D四台主机 (部署前先删除原有的相关文件数据)

* A: 172.26.10.96
* B: 172.26.10.97
* C: 172.26.10.98
* D: 172.26.10.99

### 3.1 生产环境配置说明

* 在部署前，每个节点的机器需要做一次时间同步。
* 日志等级：`-e` 指定了**额外参数**，默认**额外参数**是 `—debug`。在生产环境中可以通过 `-e " "` 覆盖日志等级， 即可开启`非debug`模式。同时`-e '--verbosity 2'`可以用来指定日志等级。
* 日志位置：生产环境需要指定日志存放路径，参考`2.4节`中 `start`的参数`-d`指定日志存放位置
* 日志分块：默认分块大小为64M。如需要指定 可参考`2.4节`中 `start`的参数`—logsize`指定分块大小。
* 通过`—bootnodes`指定同步节点，推荐使用genesis.json中的observeNoes来连接，可在`-e " "`中指定（如下例子所示）。

因此，在生产环境中：

`4.2`节中涉及到`start`启动步骤的操作步骤：

 `./platonectl.sh start -n x`

需要替换成：

`./platonectl.sh start -n x -d "\/opt\/logs"  -e "--bootnodes enode://8ab91d36a58e03c7d5528ea9186474cf5bfbec46d24cd59cf5eef1b63b2f4120334ca2a6af9ae495fa1931cdfe684caa74c86ad77fcfa0f044f4da30f7a83a4e@127.0.0.1:16791"`（具体路径需要视生产的规划）

### 3.2 启动

A中:

```bash
cd ${WORKSPACE}/scripts
./platonectl.sh clear -a
./platonectl.sh setupgen --ip 172.26.10.96 --auto true
./platonectl.sh init -n 0 --ip 172.26.10.96 --auto true
./platonectl.sh start -n 0
./platonectl.sh deploysys --auto true
./platonectl.sh init -n 1 --ip 172.26.10.97 --auto true
./platonectl.sh init -n 2 --ip 172.26.10.98 --auto true
./platonectl.sh init -n 3 --ip 172.26.10.99 --auto true
for n in $(seq 3); do
      ./platonectl.sh addnode -n ${n}
done
```

此时所需要的多机数据文件准备齐全, 拷贝数据到其他三台主机

```bash
scp -r ${WORKSPACE}/../linux user@172.26.10.97:~/
scp -r ${WORKSPACE}/../linux user@172.26.10.98:~/
scp -r ${WORKSPACE}/../linux user@172.26.10.99:~/
```

B中:

```bash
cd ~/linux/scripts
./platonectl.sh start -n 1
```

C中:

```bash
cd ~/linux/scripts
./platonectl.sh start -n 2
```

D中:

```bash
cd ~/linux/scripts
./platonectl.sh start -n 3
```

### 3.3 更新节点为共识节点

A中:

```bash
./platonectl.sh updatesys -n 1
./platonectl.sh updatesys -n 2
./platonectl.sh updatesys -n 3
```

## 4 备份

该功能支持节点未启动，以及chaindb中数据损坏的场景下，通过线下传递区块数据的方式，将某节点落后的区块数据补齐

### 4.1. export

通过export功能，将某节点指定范围内的经过RLP编码后的区块数据导出到某个文件中

```shell
./platone --datadir <待导出节点的chaindata路径> export <输出文件名> <导出区块高度下界> <导出区块高度上界>
```

### 4.2. import

通过import功能，将7.1中导出的区块数据导入指定节点

```shell
./platone --datadir <待导入节点的chaindata路径> import <区块文件名>
```

## 5. 生产日志清理策略参考

我们模拟了正常交易压力下的日志量：单节点上，24小时产出约为300M大小的日志。

* 假设在500G数据盘的规划下，按照70%的阈值保留，去除链DB数据（建议保留至少100GB），那么可以保留约27个月的数据。

* 但由于交易峰值出现的可能性，建议同时实施空间大小阈值的清理策略，即当日志总量达到500GB*70%-100GB =250GB 时，实施对最早的一个月数据的清理。

**总结：**

时间维度和空间维度的日志清理策略同时实施。

## 6. 运行状态检查&错误排查

在将链交付给业务前，我们可以从以下维度验证链的运行正确性，包括但不限于以下步骤：

1. 链运行状态检查：

   链运行日志，观察是否正常出块。（正常出块间隔在1～3秒之间）

2. 系统合约部署情况检查：

   * 系统合约的部署日志在 wasm_log文件夹中，可以监控日志中是否出现了 error 关键词，排查合约是否正常部署。

   * 通过`./platonectl.sh get` 命令，确认所有节点已经被记录到了节点管理合约。

3. 监控链运行过程的`error`或者`warning`关键词。

   （部分和节点瞬时联通性相关的，如节点互ping心跳包导致的报错信息可忽略。）
