<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>SystemContract - PlatONE</title>
    <link href="../../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../../js/jquery-3.2.1.min.js"></script>
    <script src="../../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "SystemContract", url: "#_top", children: [
              {title: "1.cnsManager", url: "#1cnsmanager" },
              {title: "2.userRegister", url: "#2userregister" },
              {title: "3.userManager", url: "#3usermanager" },
              {title: "4.roleRegister", url: "#4roleregister" },
              {title: "5.roleManager", url: "#5rolemanager" },
              {title: "6.nodeRegister", url: "#6noderegister" },
              {title: "7.nodeManager", url: "#7nodemanager" },
          ]},
        ];

    </script>
    <script src="../../../js/base.js"></script>
      <script src="../../../mathjax-config.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <div class="toc">
<ul>
<li><a href="#systemcontract">SystemContract</a><ul>
<li><a href="#1cnsmanager">1.cnsManager</a><ul>
<li><a href="#11-cnsregisterfrominit">1.1.注册合约 | cnsRegisterFromInit</a></li>
<li><a href="#12-cnsregister">1.2.注册合约 |cnsRegister</a></li>
<li><a href="#13-cnsunregister">1.3.注销特定合约 | cnsUnregister</a></li>
<li><a href="#14-getcontractaddress">1.4. 获取合约地址 |getContractAddress</a></li>
<li><a href="#15-getregisteredcontracts">1.5.获取已注册合约 |getRegisteredContracts</a></li>
<li><a href="#16-getregisteredcontractsbyaddress">1.6.获取某人已注册合约 | getRegisteredContractsByAddress</a></li>
<li><a href="#17-ifregisteredbyname">1.7. 是否已注册 |ifRegisteredByName</a></li>
<li><a href="#18-ifregisteredbyaddress">1.8. 是否已注册 |ifRegisteredByAddress</a></li>
<li><a href="#19-gethistorycontractsbyname">1.9.查询历史合约(包含已注销合约) | getHistoryContractsByName</a></li>
<li><a href="#110-getcontractinfobyaddress">1.10.获取合约信息 | getContractInfoByAddress</a></li>
</ul>
</li>
<li><a href="#2userregister">2.userRegister</a><ul>
<li><a href="#21-registeruser">2.1.添加用户申请信息 | registerUser</a></li>
<li><a href="#22-approve">2.2.审核 | approve</a></li>
<li><a href="#23-getaccountbyaddress">2.3.查询账户信息 | getAccountByAddress</a></li>
<li><a href="#24-getaccountbyusername">2.4.查询账户信息 | getAccountByUsername</a></li>
<li><a href="#25-getaccountsbystatus">2.5.分页查询某状态的用户 | getAccountsByStatus</a></li>
<li><a href="#26-getstatusbyaddress">2.6.查询用户状态 | getStatusByAddress</a></li>
</ul>
</li>
<li><a href="#3usermanager">3.userManager</a><ul>
<li><a href="#31-adduser">3.1.添加用户 | addUser</a></li>
<li><a href="#32-enable">3.2.设置用户可用 | enable</a></li>
<li><a href="#33-disable">3.3.禁用用户 | disable</a></li>
<li><a href="#34-deluser">3.4.删除用户 | delUser</a></li>
<li><a href="#35-update">3.5.更新用户信息  | update</a></li>
<li><a href="#36-getaccountbyname">3.6.获取用户信息 | getAccountByName</a></li>
<li><a href="#37-isvaliduser">3.7.是否有效 | isValidUser</a></li>
<li><a href="#38-getaccountbyaddress">3.8.获取用户信息 | getAccountByAddress</a></li>
</ul>
</li>
<li><a href="#4roleregister">4.roleRegister</a><ul>
<li><a href="#41-registerrole">4.1.注册角色 | registerRole</a></li>
<li><a href="#42-approverole">4.2.审批角色 | approveRole</a></li>
<li><a href="#43-getregisterinfobyaddress">4.3.查询角色申请信息 | getRegisterInfoByAddress</a></li>
<li><a href="#44-getregisterinfobyname">4.4.查询角色申请信息 | getRegisterInfoByName</a></li>
<li><a href="#45-getregisterinfosbystatus">4.5.查询角色申请信息 | getRegisterInfosByStatus</a></li>
</ul>
</li>
<li><a href="#5rolemanager">5.roleManager</a><ul>
<li><a href="#51-addrole">5.1.添加角色 | addRole</a></li>
<li><a href="#52-removerole">5.2.删除角色 | removeRole</a></li>
<li><a href="#53-getrolesbyaddress">5.3.查询角色 | getRolesByAddress</a></li>
<li><a href="#54-getrolesbyname">5.4.查询角色 | getRolesByName</a></li>
<li><a href="#55-getaccountsbyrole">5.5.查询账户 | getAccountsByRole</a></li>
<li><a href="#56-hasrole">5.6.是否有角色 | hasRole</a></li>
</ul>
</li>
<li><a href="#6noderegister">6.nodeRegister</a><ul>
<li><a href="#61-registernode">6.1.注册节点信息 | registerNode</a></li>
<li><a href="#62-approve">6.2.审核节点申请 | approve</a></li>
<li><a href="#63-getregisterinfobystatus">6.3.获取申请信息 | getRegisterInfoByStatus</a></li>
<li><a href="#64-getregisterinfobypublickey">6.4.获取申请信息 | getRegisterInfoByPublicKey</a></li>
<li><a href="#65-getregisterinfobyowneraddress">6.5.获取申请信息 | getRegisterInfoByOwnerAddress</a></li>
</ul>
</li>
<li><a href="#7nodemanager">7.nodeManager</a><ul>
<li><a href="#71-add">7.1.添加节点信息 | add</a></li>
<li><a href="#72-getallnodes">7.2.查询所有节点信息  | getAllNodes</a></li>
<li><a href="#73-getnodes">7.3.查询节点信息 | getNodes</a></li>
<li><a href="#74-nodesnum">7.4.符合条件节点个数 | nodesNum</a></li>
<li><a href="#75-update">7.5.更新信息 | update</a></li>
<li><a href="#76-validjoinnode">7.6.某公钥有效节点个数 | validJoinNode</a></li>
<li><a href="#77-getnormalenodenodes">7.7.正常状态节点个数 | getNormalEnodeNodes</a></li>
<li><a href="#78-getdeletedenodenodes">7.8.删除状态节点个数 | getDeletedEnodeNodes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="systemcontract">SystemContract</h1>
<h2 id="1cnsmanager">1.cnsManager</h2>
<p>各个系统合约在本合约注册，用一个map保存各个合约的地址、合约名称、版本信息。</p>
<pre class="codehilite"><code class="language-c++">struct ContractInfo
{
    std::string name;    // 注册合约名
    std::string version; // 1.0.0.0
    std::string address; // 合约地址 0x...
    std::string origin;  // 创建者地址 0x... 暂保留，具体再讨论
    int64_t create_time;     // 合约创建时间
    bool enabled;        // CNS服务是否激活
    BCWASM_SERIALIZE(ContractInfo, (name)(version)(address)(origin)(create_time)(enabled));
};</code></pre>

<h3 id="11-cnsregisterfrominit">1.1.注册合约 | cnsRegisterFromInit</h3>
<p><strong>int cnsRegisterFromInit(const char <em>name, const char </em>version)</strong></p>
<p>将已经部署的合约注册到本合约的中存储。保存所有的历史版本。</p>
<ul>
<li>必须从init()函数中调用注册，如果从合约的非init方法中调用，则注册失败。</li>
</ul>
<blockquote>
<p>input：</p>
<ul>
<li>name：</li>
</ul>
<p>​   1.合约名，需要字母数字或者下划线打头</p>
<p>​   2.合约名的所有者为第一次注册合约的部署者</p>
<ul>
<li>version：</li>
</ul>
<p>​   1.合约版本：需满足[num].[num].[num].[num]的格式，如1.0.0.0</p>
<p>​   2.注册版本必须逐步递增，不能回退注册。且版本号需要比已注销用户版本号高。</p>
<p>output:</p>
<ul>
<li>0   注册成功</li>
<li>1    注册失败</li>
</ul>
</blockquote>
<h3 id="12-cnsregister">1.2.注册合约 |cnsRegister</h3>
<p><strong>int cnsRegister(const char <em>name, const char </em>version, const char *address)</strong></p>
<ul>
<li>只有合约的所有者才能调用该接口</li>
<li>注册合约时，由用户或者合约的对外接口调用，不支持合约在自己的init()函数中调用。即如果需要在init()方法中调用统一使用cnsRegisterFromInit()接口。</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>name：</li>
</ul>
<p>​   1.合约名，需要字母数字或者下划线打头</p>
<p>​   2.合约名的所有者为第一次注册合约的部署者</p>
<ul>
<li>version：</li>
</ul>
<p>​   1.合约版本：需满足[num].[num].[num].[num]的格式，如1.0.0.0</p>
<p>​   2.注册版本必须逐步递增，不能回退注册。且版本号需要比已注销用户版        本号高。</p>
<ul>
<li>address：合约地址必须符合以太坊合约地址标准格式，"0x"前缀可写可不写。</li>
</ul>
<p>output:</p>
<ul>
<li>0 注册成功</li>
<li>1  注册失败</li>
</ul>
</blockquote>
<h3 id="13-cnsunregister">1.3.注销特定合约 | cnsUnregister</h3>
<p><strong>int cnsUnregister(char <em>name, char </em>version)</strong></p>
<ul>
<li>
<p>注销为更改合约状态参数，并非真正“删除”。</p>
</li>
<li>
<p>只有合约的owner才能调用该接口</p>
</li>
</ul>
<blockquote>
<p>input：</p>
<ul>
<li>name：</li>
</ul>
<p>​   合约名，需要字母数字或者下划线打头</p>
<ul>
<li>version：</li>
</ul>
<p>​   1.合约版本：需满足[num].[num].[num].[num]的格式，如1.0.0.0</p>
<p>​   2."latest"代表最新版本,如果最高版本合约注销则选择第二高版本。</p>
<p>output:</p>
<ul>
<li>0 注销成功</li>
<li>1 注销失败</li>
</ul>
</blockquote>
<h3 id="14-getcontractaddress">1.4. 获取合约地址 |getContractAddress</h3>
<p><strong>const char <em>getContractAddress(char </em>name, char *version) const</strong></p>
<ul>
<li>非读写操作的获取信息任何人都可操作无需任何权限</li>
</ul>
<blockquote>
<p>input：</p>
<ul>
<li>name：</li>
</ul>
<p>​   合约名，需要字母数字或者下划线打头</p>
<ul>
<li>version：</li>
</ul>
<p>​   1.合约版本：需满足[num].[num].[num].[num]的格式，如1.0.0.0</p>
<p>​   2."latest"代表最新版本,如果最高版本合约注销则选择第二高版本。</p>
<p>output:</p>
<ul>
<li>address：标准以太坊地址（含“0x”前缀）</li>
</ul>
</blockquote>
<h3 id="15-getregisteredcontracts">1.5.获取已注册合约 |getRegisteredContracts</h3>
<p><strong>char *getRegisteredContracts(int pageNum, int pageSize) const</strong></p>
<blockquote>
<p>input：</p>
<ul>
<li>pageNum：</li>
</ul>
<p>​   页面编号（从0开始），参数≥0。</p>
<ul>
<li>pageSize：</li>
</ul>
<p>​   每页显示条目数, 参数≥1。</p>
<p>output:</p>
<ul>
<li>合约信息的json字符串</li>
</ul>
</blockquote>
<h3 id="16-getregisteredcontractsbyaddress">1.6.获取某人已注册合约 | getRegisteredContractsByAddress</h3>
<p><strong>char <em>getRegisteredContractsByAddress(char </em>origin, int pageNum, int pageSize) const</strong></p>
<blockquote>
<p>input：</p>
<ul>
<li>origin：</li>
</ul>
<p>​   合约地址必须符合以太坊合约地址标准格式，“0x”前缀可写可不写</p>
<ul>
<li>pageNum：</li>
</ul>
<p>​   页面编号（从0开始），参数≥0。</p>
<ul>
<li>pageSize：</li>
</ul>
<p>​   每页显示条目数 , 参数≥1 。</p>
<p>output:</p>
<ul>
<li>合约信息的json字符串</li>
</ul>
</blockquote>
<h3 id="17-ifregisteredbyname">1.7. 是否已注册 |ifRegisteredByName</h3>
<p><strong>int ifRegisteredByName(char *name) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>name :合约名，需要字母数字或者下划线打头</li>
</ul>
<p>output:</p>
<ul>
<li>0 未注册</li>
<li>1 已注册</li>
</ul>
</blockquote>
<h3 id="18-ifregisteredbyaddress">1.8. 是否已注册 |ifRegisteredByAddress</h3>
<p><strong>int ifRegisteredByAddress(char *address) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>address：合约地址必须符合以太坊合约地址标准格式，"0x"前缀可写可不写</li>
</ul>
<p>output:</p>
<ul>
<li>0 未注册</li>
<li>1 已注册</li>
</ul>
</blockquote>
<h3 id="19-gethistorycontractsbyname">1.9.查询历史合约(包含已注销合约) | getHistoryContractsByName</h3>
<p><strong>char <em>getHistoryContractsByName(char </em>name) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>name：合约名，需要字母数字或者下划线打头</li>
</ul>
<p>output:</p>
<ul>
<li>合约信息的json字符串</li>
</ul>
</blockquote>
<h3 id="110-getcontractinfobyaddress">1.10.获取合约信息 | getContractInfoByAddress</h3>
<p><strong>char<em> getContractInfoByAddress(char </em>address) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>address：合约地址必须符合以太坊合约地址标准格式，"0x"前缀可写可不写</li>
</ul>
<p>output:</p>
<ul>
<li>0 未注册</li>
<li>1 已注册</li>
</ul>
</blockquote>
<h2 id="2userregister">2.userRegister</h2>
<p>申请用户指的是，用户将个人的账户地址、用户名称、电话、邮箱、个人说明，向合约发起申请，合约保存信息。</p>
<pre class="codehilite"><code class="language-c++">    struct RegisterInfo {
        std::string user_address;     // 用户账户地址
        std::string name;             // 用户名称
        std::string mobile;           // 手机号
        std::string email;            // 邮箱
        std::string remark;           // 个人说明
        unsigned int user_state;      // 平台用户状态：1审核中，2已激活，3已拒绝
        std::string auditor_address;  // 审核人的地址
    //  std::string roles;            // 角色请求列表
        std::vector&lt;string&gt; roles;   // 角色请求列表
    };</code></pre>

<h3 id="21-registeruser">2.1.添加用户申请信息 | registerUser</h3>
<p><strong>int registerUser(const char* registJson)</strong></p>
<ul>
<li>需本人申请</li>
<li>限制申请次数1次，审核失败或者已激活用户无法再次申请</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>registJson ：</li>
</ul>
<p>用户申请信息JSON结构体字符串，字符串长度&gt;800则注册失败</p>
<p>output:</p>
<ul>
<li>0 未注册</li>
<li>1 已注册</li>
</ul>
</blockquote>
<p>Json字符串参考格式如下：</p>
<pre class="codehilite"><code class="language-json">'{"address":"0x33d253386582f38c66cb5819bfbdaad0910339b3","name":"xiaoluo","mobile":"13111111111","email":"luodahui@qq.com","roles":["a","b","c"],"remark":"平台用户申请"}'</code></pre>

<h3 id="22-approve">2.2.审核 | approve</h3>
<p><strong>int approve(const char* userAddress, int auditStatus)</strong></p>
<ul>
<li>对申请用户进行审核，审核成功后在待审核中列表中删除。审核人需为有效用户及管理员。</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>
<p>userAddress 用户地址。</p>
</li>
<li>
<p>auditStatus 审核状态： 2 激活，3 拒绝。</p>
</li>
</ul>
<p>output:</p>
<ul>
<li>int 审核成功返回0，失败返回-1。</li>
</ul>
</blockquote>
<h3 id="23-getaccountbyaddress">2.3.查询账户信息 | getAccountByAddress</h3>
<p><strong>const char<em> getAccountByAddress(const char</em> address) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>address 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{"code":0,"msg":"succeed","data":{ ....}}'</code></pre>

<p>如果用户申请不存在，返回错误信息：</p>
<pre class="codehilite"><code class="language-json">'{"code":1,"msg":"The user does not exist in the userRegisterManager", "data":""}'</code></pre>

</blockquote>
<h3 id="24-getaccountbyusername">2.4.查询账户信息 | getAccountByUsername</h3>
<p><strong>const char<em> getAccountByUsername(const char</em> UserName) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>UserName 用户名</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{"code":0,"msg":"succeed","data":{ ....}}'</code></pre>

<p>如果用户申请不存在，返回错误信息：</p>
<pre class="codehilite"><code class="language-json">'{"code":1,"msg":"The user does not exist in the userRegisterManager", "data":""}'</code></pre>

</blockquote>
<h3 id="25-getaccountsbystatus">2.5.分页查询某状态的用户 | getAccountsByStatus</h3>
<p><strong>const char* getAccountsByStatus(int pageNum, int pageSize, int accountStatus) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>pageNum 页码 ，参数≥0。</li>
<li>pageSize 每页的数据条数，参数≥1。</li>
<li>accountStatus 用户状态：1审核中，2已激活，3已拒绝</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{"code":0,"msg":"succeed","data":{ ....}}'</code></pre>

<p>错误输出：</p>
<pre class="codehilite"><code class="language-c++"> unsigned int  startIndex = pageNum * pageSize;
 unsigned int endIndex = startIndex + pageSize - 1;
       if (startIndex &gt;= size) 
           {
               code = "1";
             message = "Adjust pageNum and pageSize";
            }</code></pre>

<pre class="codehilite"><code class="language-c++"> {
          //  bcwasm::println("状态用户不存在：[", accountStatus, "],请检查");
                 code = "2";
                message = "The user status for the query does not exist in the UserRegister";
                 userInfos = "\"\"";
   }</code></pre>

<pre class="codehilite"><code class="language-c++">  {
                 code = "3";
                 message = "user information is empty in the UserRegister";
                  userInfos = "\"\"";
 }</code></pre>

</blockquote>
<h3 id="26-getstatusbyaddress">2.6.查询用户状态 | getStatusByAddress</h3>
<p><strong>int getStatusByAddress(const char* address) const</strong> </p>
<blockquote>
<p>input:</p>
<ul>
<li>address：用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>int 查询成功返回用户状态1,2,3，失败返回-1。</li>
</ul>
</blockquote>
<h2 id="3usermanager">3.userManager</h2>
<p>用来管理平台用户的邮箱，手机号及用户状态。</p>
<pre class="codehilite"><code class="language-c++">    struct UserInfo
    {
        string user_address;    // 用户地址
        string name;//用户名称 
        string email; //用户邮箱 
       string mobile; //手机号
        unsigned int status;        // 是否禁用用户：[0:可用; 1:禁用; 2:删除] 
    };</code></pre>

<h3 id="31-adduser">3.1.添加用户 | addUser</h3>
<p><strong>int addUser(const char* userJson)</strong></p>
<ul>
<li>调用者需为有效用户及管理员，用户需为已激活用户。</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>userJson 用户信息JSON结构体字符串</li>
</ul>
<p>output:</p>
<ul>
<li>int 添加用户成功返回0，失败返回-1.</li>
</ul>
</blockquote>
<p>Json字符串参考格式如下：</p>
<pre class="codehilite"><code class="language-json">'{"address":"0x33d253386582f38c66cb5819bfbdaad0910339b3","name":"xiaoluo","mobile":"13111111111","email":"luodahui@qq.com","roles":["a","b","c"],"remark":"平台用户申请"}'</code></pre>

<h3 id="32-enable">3.2.设置用户可用 | enable</h3>
<p><strong>int enable(const char* userAddr)</strong></p>
<ul>
<li>调用者需为可用用户且role为管理员。其中超管状态不可被修改恒为可用状态，普管状态可由任何普管（包括自己）和超管修改。</li>
<li>已删除用户状态不能被变更，仅有可用和不可用状态可以被修改。</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>userAddr 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>int 设置成功返回0，失败返回-1.</li>
</ul>
</blockquote>
<h3 id="33-disable">3.3.禁用用户 | disable</h3>
<p><strong>int disable(const char* userAddr)</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>userAddr 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>int 设置成功返回0，失败返回-1.</li>
</ul>
</blockquote>
<h3 id="34-deluser">3.4.删除用户 | delUser</h3>
<p><strong>int delUser(const char* userAddr)</strong></p>
<ul>
<li>已删除用户不能变更状态</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>userAddr 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>int 设置成功返回0，失败返回-1.</li>
</ul>
</blockquote>
<h3 id="35-update">3.5.更新用户信息  | update</h3>
<p><strong>int update(const char<em> userAddr, const char</em> updateJson)</strong></p>
<p>功能：更新用户信息，只能更新用户的email,mobile信息</p>
<ul>
<li>
<p>每个可用用户都可以修改自己的信息。</p>
</li>
<li>
<p>修改他人信息时，调用者需为有效用户且为管理员，其中超管有修改一切的权限，普管仅能修改普通用户。且用户需为有效用户。</p>
</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>userAddr 用户地址</li>
<li>updateJson 更新信息的json结构体字符串</li>
</ul>
<p>output:</p>
<ul>
<li>int 添加用户成功返回0，失败返回-1.</li>
</ul>
</blockquote>
<h3 id="36-getaccountbyname">3.6.获取用户信息 | getAccountByName</h3>
<p>const char<em> getAccountByName(const char</em> name) const</p>
<blockquote>
<p>input:</p>
<ul>
<li>name 用户名</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<p><code>json
   '{"code":0,"msg":"succeed","data":{ ....}}'</code></p>
<p>​   如果用户申请不存在，返回错误信息：</p>
<p><code>json
   '{"code":1,"msg":"The user does not exist in the userRegisterManager", "data":""}'</code>
</p>
</blockquote>
<h3 id="37-isvaliduser">3.7.是否有效 | isValidUser</h3>
<p><strong>int isValidUser(const char* userAddr) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>userAddr 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>int 返回0为有效用户，-1为非有效用户</li>
</ul>
</blockquote>
<h3 id="38-getaccountbyaddress">3.8.获取用户信息 | getAccountByAddress</h3>
<p><strong>const char<em> getAccountByAddress(const char</em> address) const</strong></p>
<blockquote>
<p>input:</p>
<ul>
<li>address 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{"code":0,"msg":"succeed","data":{ ....}}'</code></pre>

<p>​  如果用户申请不存在，返回错误信息：</p>
<p><pre class="codehilite"><code class="language-json"> '{"code":1,"msg":"The user does not exist in the userRegisterManager", "data":""}'</code></pre>
</p>
</blockquote>
<h2 id="4roleregister">4.roleRegister</h2>
<p>用以申请角色、审批角色、以及查询角色申请信息。</p>
<pre class="codehilite"><code class="language-c++"> typedef struct RegisterUserInfo {
       std::string userAddress;       //账户地址
        std::string userName;            //用户名
        int roleRequireStatus;  //角色申请状态 1 申请中 2 已批准 3 已拒绝
        std::vector&lt;std::string&gt; requireRoles;
        std::string approver;         //审核人的地址
        BCWASM_SERIALIZE(RegisterUserInfo, (userAddress)(userName)(roleRequireStatus)(requireRoles)(approver));
    }RegisterUserInfo_st;</code></pre>

<p>具体角色及权限请参照PlatONE合约指导文档。</p>
<h3 id="41-registerrole">4.1.注册角色 | registerRole</h3>
<p><strong>int registerRole(const char* roles)</strong> </p>
<ul>
<li>记录用户申请信息,一个账户可以同时申请多个角色，只能申请一次。</li>
</ul>
<blockquote>
<p>input:</p>
<ul>
<li>inputs : const char* roles</li>
</ul>
<p>eg: [ \"chainAdmin\",\"nodeAdmin\"]</p>
<p>output:</p>
<ul>
<li>return 含义如下：
   0 注册成功
   1 地址状态不正确
   4 输入参数不正确，不是list类型
   6 没有有效的申请信息
   7 角色名称无效</li>
</ul>
</blockquote>
<h3 id="42-approverole">4.2.审批角色 | approveRole</h3>
<p>int approveRole(const char* address, int status)</p>
<p>只能审核比自己权限更低的角色申请。 </p>
<blockquote>
<p>input: address ， status</p>
<p>output:</p>
<ul>
<li>return 含义如下：</li>
</ul>
<p>0 注册成功</p>
<p>1 账号地址格式错误</p>
<p>1审批人用户状态不正确</p>
<p>2 角色权限不足</p>
<p>3 没有角色申请信息 </p>
<p>4 未找到角色管理合约</p>
<p>5 不是合法的审批值</p>
<p>6 当前是非审批状态 </p>
<p>7 添加角色失败</p>
</blockquote>
<h3 id="43-getregisterinfobyaddress">4.3.查询角色申请信息 | getRegisterInfoByAddress</h3>
<p>const char * getRegisterInfoByAddress(const char* address) const</p>
<blockquote>
<p>input: address</p>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串 ： {状态值, msg, RegisterUserInfo}</li>
</ul>
</blockquote>
<p>output返回格式如下：</p>
<pre class="codehilite"><code class="language-json">{
    code: 0,
    msg: "ok",
    data: {
        "userAddress": "0x111222",
        "userName": "xiaoming",
        "roleRequireStatus": 1,
        "requireRoles":["Admin", "ContractCaller"],
        "approveor": "01xxx"
    }
}</code></pre>

<p>错误输出格式：</p>
<pre class="codehilite"><code class="language-json">{
    code:1,
    msg: "not found",
    data: {
    }
}</code></pre>

<h3 id="44-getregisterinfobyname">4.4.查询角色申请信息 | getRegisterInfoByName</h3>
<p>const char * getRegisterInfoByName(const char* name) const</p>
<blockquote>
<p>input: name</p>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串 ： {状态值, msg, RegisterUserInfo}</li>
</ul>
</blockquote>
<h3 id="45-getregisterinfosbystatus">4.5.查询角色申请信息 | getRegisterInfosByStatus</h3>
<p>const char * getRegisterInfosByStatus(int status, int pageNum, int pageSize) const</p>
<blockquote>
<p>input:</p>
<ul>
<li>pageNum 页码 ，参数≥0。</li>
<li>pageSize 每页的数据条数，参数≥1。</li>
<li>accountStatus 用户状态：1审核中，2已激活，3已拒绝</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串</li>
</ul>
</blockquote>
<h2 id="5rolemanager">5.roleManager</h2>
<p>用来管理平台用户的角色。</p>
<pre class="codehilite"><code class="language-c++">namespace SystemContract
{
    struct userRole{
        bcwasm::Address address;
        string name;
        vector&lt;string&gt; roles;
        BCWASM_SERIALIZE(userRole,(address)(name)(roles));
    };</code></pre>

<h3 id="51-addrole">5.1.添加角色 | addRole</h3>
<p>int addRole(const char <em>name, const char </em>address, const char *roles)</p>
<ul>
<li>对相同地址来说，如果已存在并用户名一样，则更新角色；用户名不一样返回6</li>
</ul>
<blockquote>
<p>input: name ， address , roles</p>
<p>output:</p>
<ul>
<li>return 含义如下：</li>
</ul>
<p>0  Add roles success</p>
<p>1 Address format is invalid.</p>
<p>2 Caller unavailable, status: </p>
<p>3  User unavailable, status: </p>
<p>4 Roles invalid: </p>
<p>5 No permission to remove/addrole for roles: </p>
<p>6  Name must be unique</p>
<p>7 Add Roles failed </p>
</blockquote>
<h3 id="52-removerole">5.2.删除角色 | removeRole</h3>
<p>int removeRole(const char <em>address,const char </em>roles)</p>
<ul>
<li>调用者需为普管或者超管。其中超管状态不可被修改恒为可用状态，普管状态可由任何普管（包括自己）和超管修改。</li>
</ul>
<blockquote>
<p>input: address , roles</p>
<p>output:</p>
<ul>
<li>return 含义如下：</li>
</ul>
<p>0   Remove roles success. </p>
<p>1     Address format is invalid. </p>
<p>2   Caller unavailable, status: "+ to_string(userStatus) + " , Address: " + string(address)</p>
<p>3    Cannot found address: " +  string(address)</p>
<p>4   Roles invalid: " + string(roles)</p>
<p>5   No permission to remove for roles: " + string(roles)</p>
</blockquote>
<h3 id="53-getrolesbyaddress">5.3.查询角色 | getRolesByAddress</h3>
<p>const char<em> getRolesByAddress(const char </em>address)const</p>
<blockquote>
<p>input:</p>
<ul>
<li>address 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{"code":0,"msg":"Success","data":{ ....}}'</code></pre>

<p>​ 错误返回如下两种情况：</p>
<pre class="codehilite"><code class="language-json">'{"code":1,"msg":"Address format is invalid.", "data":""}'     
'{"code":1,"msg":"Not Found", "data":""}'</code></pre>

</blockquote>
<h3 id="54-getrolesbyname">5.4.查询角色 | getRolesByName</h3>
<p>const char<em> getRolesByName(const char </em>name)const</p>
<blockquote>
<p>input:</p>
<ul>
<li>address 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{"code":0,"msg":"Success","data":{ ....}}'</code></pre>

<p>​ 错误返回如下：</p>
<pre class="codehilite"><code class="language-json">'{"code":1,"msg":"Not Found", "data":""}'</code></pre>

</blockquote>
<h3 id="55-getaccountsbyrole">5.5.查询账户 | getAccountsByRole</h3>
<p>const char<em> getAccountsByRole(const char </em>role)const</p>
<blockquote>
<p>input:</p>
<ul>
<li>address 用户地址</li>
</ul>
<p>output:</p>
<ul>
<li>const char* 返回json格式字符串，格式如下：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{"code":0,"msg":"Success","data":{ ....}}'</code></pre>

<p>​ 错误返回如下：</p>
<pre class="codehilite"><code class="language-json">'{"code":1,"msg":"Not Found", "data":""}'
'{"code":1,"msg":"role parameter invalid", "data":""}'</code></pre>

</blockquote>
<h3 id="56-hasrole">5.6.是否有角色 | hasRole</h3>
<p>int hasRole(const char<em> addr, const char</em> role) const</p>
<blockquote>
<p>input:</p>
<ul>
<li>address 用户地址</li>
<li>role  角色json格式字符串</li>
</ul>
<p>output:</p>
<ul>
<li>int 返回0为没有，1为有</li>
</ul>
</blockquote>
<h2 id="6noderegister">6.nodeRegister</h2>
<pre class="codehilite"><code class="language-c++">struct RegisterInfo
{
    std::string name;      //节点名称
    std::string owner;     //申请者的地址
    std::string desc;      //节点描述,长度限制1000
    int type;              //1:共识节点；0:观察者节点
    std::string publicKey; //公钥
    std::string externalIP;
    std::string internalIP;
    int rpcPort;
    int p2pPort;
    int status;           //0:未处理；1:申请通过；2:拒绝申请
    bool root;            //true 根节点 false 非跟节点
    std::string approver; //审核人的地址
    int64_t registerTime; //申请时间
    BCWASM_SERIALIZE(RegisterInfo, (name)(owner)(desc)(type)(publicKey)(externalIP)(internalIP)(rpcPort)(p2pPort)(status)(root)(approver)(registerTime));
};</code></pre>

<h3 id="61-registernode">6.1.注册节点信息 | registerNode</h3>
<p>int registerNode(const char *nodeJson)</p>
<ul>
<li>只能由chainCreater、chainAdmin、nodeAdmin调用</li>
<li>name：只可包含字母、数字、下划线、连字符，审核通过的name不可以重复</li>
<li>desc：长度限制为4-1000</li>
<li>type：必须是0或者1，0表示观察者节点</li>
<li>publicKey：长度限制为4-1000，publicKey不能重复申请</li>
<li>IP和端口：任意组合审核通过后，不能重复申请</li>
</ul>
<blockquote>
<p>inputs: </p>
<p>RegisterInfo是Json字符串，包含以下内容：</p>
<pre class="codehilite"><code class="language-json">'{
    "name":"node1",
    "desc":"i love this world",
    "type":1,
  "publicKey":"acb2281452fb9fc25d40113fb6afe82b498361de0eea6449c2502",
    "externalIP":"127.0.0.1",
    "internalIP":"127.0.0.1",
    "rpcPort":4789,
    "p2pPort":14789
}'</code></pre>

<p>output: int</p>
<p>​ 0   成功</p>
<p>​ 1   参数不规范</p>
<p>​ 2   无权限</p>
</blockquote>
<h3 id="62-approve">6.2.审核节点申请 | approve</h3>
<p>int approve(char *publicKey, int status)</p>
<ul>
<li>只能由chainCreater、chainAdmin调用</li>
<li>如果状态是已审核，不能重新审核</li>
<li>审核通过的name、IP+Port不可以再次审核通过</li>
<li>当审核通过（status = 1）后，系统调用NodeManager合约的add()方法把节点信息放入节点管理合约</li>
</ul>
<blockquote>
<p>inputs: </p>
<ul>
<li>publicKey:不能为空，如果没申请过则无效</li>
<li>status：必须是1或者2，1表示通过，2表示拒绝</li>
</ul>
<p>output: int</p>
<p>​ 0   成功</p>
<p>​ 1   参数不规范</p>
<p>​ 2   无权限</p>
</blockquote>
<h3 id="63-getregisterinfobystatus">6.3.获取申请信息 | getRegisterInfoByStatus</h3>
<p>const char *getRegisterInfoByStatus(int status, int pageNum, int pageSize) const</p>
<blockquote>
<p>inputs: </p>
<ul>
<li>status:查询状态，0申请未处理、1申请通过、2申请拒绝</li>
<li>pageNum：页面编号（从0开始）</li>
<li>pageSize：每页显示条目数</li>
</ul>
<p>output: </p>
<pre class="codehilite"><code class="language-json">{
    "code":0,
    "msg":"",
    "data":{
        "name":"node1",
        "owner":"0x4FCd6fe35f0612C7866943cb66C1d93eb0746bcC",
        "desc":"i love this world",
        "type":1,     "publicKey":"acb2281452fb9fc25d40113fb6afe82b498361de0eea6449c2502",
        "externalIP":"127.0.0.1",
        "internalIP":"127.0.0.1",
        "rpcPort":4789,
        "p2pPort":14789,
        "status":0,        "approveor":"0x4FCd6fe35f0612C7866943cb66C1d93eb0746bcC",
        "registerTime":23489723
    }
}</code></pre>

<p>错误输出格式：</p>
<pre class="codehilite"><code class="language-json">{
    code:1,
    msg: "Can't find info",
    data: {
    }
}</code></pre>

<pre class="codehilite"><code class="language-json">{
    code:2,
    msg: "Parameter error!",
    data: {
    }
}</code></pre>

</blockquote>
<h3 id="64-getregisterinfobypublickey">6.4.获取申请信息 | getRegisterInfoByPublicKey</h3>
<p>const char <em>getRegisterInfoByPublicKey(char </em>publicKey) const</p>
<blockquote>
<p>inputs: </p>
<ul>
<li>publicKey：申请过的公钥</li>
</ul>
<p>output:  返回Json字符串</p>
</blockquote>
<h3 id="65-getregisterinfobyowneraddress">6.5.获取申请信息 | getRegisterInfoByOwnerAddress</h3>
<p>const char <em>getRegisterInfoByOwnerAddress(char </em>owner) const</p>
<blockquote>
<p>inputs: </p>
<ul>
<li>ownerAddress：申请者地址</li>
</ul>
<p>output:  返回Json字符串</p>
</blockquote>
<h2 id="7nodemanager">7.nodeManager</h2>
<pre class="codehilite"><code class="language-c++">//此结构体已注释掉，代码部分不是通过结构体方式定义以下变量
{
    string name;       // 节点名字
    address owner;     // 申请者的地址
    string desc;       // 节点描述
    int type;          // 0:观察者节点；1:共识节点
    string publicKey;  // 节点公钥
    string externalIP; // 外网 IP
    string internalIP; // 内网 IP
    int rpcPort;       // rpc 通讯端口
    int p2pPort;       // p2p 通讯端口
    int status;        // 1:正常；2：删除
    address approveor; // 审核人的地址
    int delayNum;      // 共识节点延迟设置的区块高度 (可选, 默认实时设置)
}</code></pre>

<h3 id="71-add">7.1.添加节点信息 | add</h3>
<p>int add(const char *nodeJsonStr)</p>
<ul>
<li>必要的key:{"name", "owner", "desc", "type", "publicKey", "externalIP", "internalIP", "rpcPort", "p2pPort", "status"}</li>
<li>只有chainCreator，chainAdmin，nodeAdmin可添加节点信息</li>
<li>公钥必须唯一</li>
<li>节点名字不能与非删除节点重复</li>
<li>添加节点时类型必须是观察者节点，即type=0</li>
<li>添加节点的status只能是1或2</li>
</ul>
<blockquote>
<p>inputs: </p>
<ul>
<li>nodeJsonStr 节点信息JSON结构体字符串，如：</li>
</ul>
<pre class="codehilite"><code class="language-json">'{
    "name": "node1",
    "owner": "0x4FCd6fe35f0612C7866943cb66C1d93eb0746bcC",
    "approveor": "0xdF6518e51e0d90A3CBa26e4AdFE74454E2D90BdE",
    "desc": "i love this world",
    "type": 1,
    "publicKey": "0x81ec63a2335c1f79244cbe485eb6bffef48cfd7df58b1009411c6114670eefd27da865914c70f7e49ceeb1002f1c24f4930975a2eb05cb5ac1373bed83a9932a",
    "externalIP": "127.0.0.1",
    "internalIP": "127.0.0.1",
    "rpcPort": 6789,
    "p2pPort": 16789,
    "status": 1
}'</code></pre>

<p>output: int</p>
<p>​ 0   成功</p>
<p>​ 1   参数不规范</p>
<p>​ 2   无权限</p>
</blockquote>
<h3 id="72-getallnodes">7.2.查询所有节点信息  | getAllNodes</h3>
<p>const char *getAllNodes() const</p>
<blockquote>
<p>inputs: 无</p>
<p>outputs：</p>
<p>​ nodes 所有节点信息JSON结构体字符串</p>
<pre class="codehilite"><code class="language-json">{
  "code": 0,
  "msg": "success",
  "data": [...]
           }</code></pre>

</blockquote>
<h3 id="73-getnodes">7.3.查询节点信息 | getNodes</h3>
<p>const char <em>getNodes(const char </em>nodeJsonStr) const</p>
<blockquote>
<p>inputs: </p>
<p>​ 根据特定条件，返回符合条件的节点信息。比如，我需要查询节点的名字为"node1"的节点信息，那么传入字符串 {"name":"node1"}；如果需要查询所有正常节点，那么传入字符串{"status":1}；如果我需要返回正常节点而且是共识节点，那么传入字符串{"status":1, "type":1}。总之，你可以根据节点信息可多个组合进行查询。</p>
<p>outputs：</p>
<p>​ nodes 所有符合条件的节点信息JSON结构体字符串</p>
<pre class="codehilite"><code class="language-json">{
  "code": 0,
  "msg": "success",
  "data": [...]
           }</code></pre>

</blockquote>
<h3 id="74-nodesnum">7.4.符合条件节点个数 | nodesNum</h3>
<p>int nodesNum(const char *nodeJsonStr) const</p>
<blockquote>
<p>inputs: </p>
<p>​ 一些条件的JSON结构体字符串</p>
<p>outputs：</p>
<p>​ nodes 所有符合条件的节点个数。</p>
</blockquote>
<h3 id="75-update">7.5.更新信息 | update</h3>
<p>int update(const char <em>name, const char </em>nodeJsonStr)</p>
<ul>
<li>CHAIN_CREATOR，CHAIN_ADMIN，NODE_ADMIN才有权限update</li>
<li>非正常状态的节点, 不能进行更新（status!=1）</li>
<li>节点status 只能从1更新为2</li>
<li>节点type 只能在0和1之间进行更新</li>
<li>更新节点信息只能是：desc, type, status, delayNum</li>
</ul>
<blockquote>
<p>inputs: </p>
<ul>
<li>name 节点名字</li>
<li>nodeJsonStr 需要更新的信息，以json表示。</li>
</ul>
<p>output: int</p>
<p>​ 0   失败</p>
<p>​ 1   成功</p>
</blockquote>
<h3 id="76-validjoinnode">7.6.某公钥有效节点个数 | validJoinNode</h3>
<p>int validJoinNode(const char *publicKey) const</p>
<blockquote>
<p>inputs: </p>
<ul>
<li>publicKey</li>
</ul>
<p>output: </p>
<ul>
<li>int   输出某公钥下所有有效的（status=1）节点个数</li>
</ul>
</blockquote>
<h3 id="77-getnormalenodenodes">7.7.正常状态节点个数 | getNormalEnodeNodes</h3>
<p>const char *getNormalEnodeNodes() const</p>
<blockquote>
<p>inputs: 无</p>
<p>output: </p>
<ul>
<li>int   输出正常状态的节点个数</li>
</ul>
</blockquote>
<h3 id="78-getdeletedenodenodes">7.8.删除状态节点个数 | getDeletedEnodeNodes</h3>
<p>const char *getDeletedEnodeNodes() const</p>
<blockquote>
<p>inputs: 无</p>
<p>output: </p>
<ul>
<li>int   输出删除状态的节点个数</li>
</ul>
</blockquote>

  <br>
    

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>