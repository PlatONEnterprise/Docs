<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Java - SDK - PlatONE</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Java - SDK", url: "#_top", children: [
              {title: "1. \u4e0b\u8f7d\u4e0e\u5b89\u88c5", url: "#1" },
              {title: "2. \u8fde\u63a5\u8282\u70b9", url: "#2" },
              {title: "3. \u5408\u7ea6\u4ea4\u4e92", url: "#3" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../mathjax-config.js"></script>
      <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E6%B5%8F%E8%A7%88%E5%99%A8/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%B5%8F%E8%A7%88%E5%99%A8%E9%85%8D%E7%BD%AE/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E6%B5%8F%E8%A7%88%E5%99%A8/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%B5%8F%E8%A7%88%E5%99%A8%E9%85%8D%E7%BD%AE/" class="btn btn-xs btn-link">
        浏览器
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../SDK%E6%A6%82%E8%BF%B0/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../SDK%E6%A6%82%E8%BF%B0/" class="btn btn-xs btn-link">
        SDK概述
      </a>
    </div>
    
  </div>

    

    <h1 id="java-sdk">Java - SDK</h1>
<p>PlatONE Java SDK是面向java开发者，提供的PlatONE联盟链的java开发工具包，提供了在应用层（java 代码）访问区块链节点并获取服务的接口，比如部署合约、调用合约、查询链上数据等。</p>
<h2 id="1">1. 下载与安装</h2>
<p>请首先下载SDK最新版本的发布包，<a href="https://github.com/PlatONEnterprise/PlatONE-Go/releases">下载地址</a>。</p>
<p>将发布包解压到本地目录，如下所示：</p>
<pre class="codehilite"><code class="language-shell"># 下载
wget https://github.com/PlatONEnterprise/PlatONE-Go/releases/download/v0.9.0/java_sdk_linux_v0.9.0.tar.gz
# 解压
tar -zxvf java_sdk_linux_v0.9.0.tar.gz &amp;&amp; export SDKPATH=java-sdk</code></pre>

<p>安装依赖环境</p>
<pre class="codehilite"><code class="language-shell"># java版本：jdk1.8
sudo apt install cmake g++ maven
# 安装maven依赖
cd ${SDKPATH}/bin &amp;&amp; ./mvn.sh</code></pre>

<p>创建java项目并在maven配置文件中添加如下的依赖项：</p>
<pre class="codehilite"><code class="language-js">    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.platone.client&lt;/groupId&gt;
            &lt;artifactId&gt;core&lt;/artifactId&gt;
            &lt;version&gt;0.4.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.platone.client&lt;/groupId&gt;
            &lt;artifactId&gt;crypto&lt;/artifactId&gt;
            &lt;version&gt;0.4.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.platone.client&lt;/groupId&gt;
            &lt;artifactId&gt;abi&lt;/artifactId&gt;
            &lt;version&gt;0.4.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.platone.client&lt;/groupId&gt;
            &lt;artifactId&gt;rlp&lt;/artifactId&gt;
            &lt;version&gt;0.4.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.platone.client&lt;/groupId&gt;
            &lt;artifactId&gt;tuples&lt;/artifactId&gt;
            &lt;version&gt;0.4.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.platone.client&lt;/groupId&gt;
            &lt;artifactId&gt;utils&lt;/artifactId&gt;
            &lt;version&gt;0.4.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
            &lt;version&gt;1.7.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
            &lt;version&gt;1.7.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;
            &lt;artifactId&gt;okhttp&lt;/artifactId&gt;
            &lt;version&gt;3.8.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;
            &lt;artifactId&gt;logging-interceptor&lt;/artifactId&gt;
            &lt;version&gt;3.8.1&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.reactivex&lt;/groupId&gt;
            &lt;artifactId&gt;rxjava&lt;/artifactId&gt;
            &lt;version&gt;1.2.4&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.java-websocket&lt;/groupId&gt;
            &lt;artifactId&gt;Java-WebSocket&lt;/artifactId&gt;
            &lt;version&gt;1.3.8&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.jnr&lt;/groupId&gt;
            &lt;artifactId&gt;jnr-unixsocket&lt;/artifactId&gt;
            &lt;version&gt;0.15&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
            &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
            &lt;version&gt;2.8.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;
            &lt;artifactId&gt;bcprov-jdk15on&lt;/artifactId&gt;
            &lt;version&gt;1.54&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;</code></pre>

<h2 id="2">2. 连接节点</h2>
<p>首先需要与PlatONE节点建立连接，以获取链上有关服务。PlatONE支持建立http连接和websocket连接两种方式。</p>
<pre class="codehilite"><code class="language-java">//http短连接
Web3j web3j = Web3j.build(new HttpService("http://127.0.0.1:6791"));</code></pre>

<pre class="codehilite"><code class="language-java">//ws长连接
WebSocketClient webSocketClient = new WebSocketClient(newURI("ws://127.0.0.1:6791"));
WebSocketService ws = new WebSocketService(webSocketClient，true);
ws.connect();
Web3j web3j = Web3j.build(ws);</code></pre>

<p>说明：</p>
<ol>
<li>建立Websocket连接需要显式调用connect方法（与HTTP不同）。</li>
<li>PlatONE节点需要在启动时打开websocket监听功能，即启动时加入参数：--ws。</li>
</ol>
<h2 id="3">3. 合约交互</h2>
<p>为了方便在java项目中调用链上合约，需要首先生成合约对应的java类，在项目中创建合约类实例后，便可以调用合约。</p>
<h3 id="31">3.1 合约骨架生成</h3>
<ol>
<li>
<p>编写合约(以demo为例)，编写合约的步骤请参阅<a href="../../%E6%93%8D%E4%BD%9C%E6%89%8B%E5%86%8C/%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91-cpp%E5%90%88%E7%BA%A6%E5%BC%80%E5%8F%91/">Wasm合约开发</a>。</p>
<pre class="codehilite"><code class="language-cpp">
    #include &lt;stdlib.h&gt;
    #include &lt;string.h&gt;
    #include &lt;string&gt;
    #include &lt;bcwasm/bcwasm.hpp&gt;

    namespace demo {
        class FirstDemo : public bcwasm::Contract
        {
            public:
                FirstDemo(){}

                /// 实现父类: bcwasm::Contract 的虚函数
                /// 该函数在合约首次发布时执行，仅调用一次
                void init()
                {
                    bcwasm::println("init success...");
                }
            public:
                void setName(const char *msg)
                {
                    // 定义状态变量
                    bcwasm::setState("NAME_KEY"，std::string(msg));
                }

                const char* getName() const
                {
                    std::string value;
                    bcwasm::getState("NAME_KEY"，value);
                    // 读取合约数据并返回
                    return value.c_str();
                }
        };
    }
    // 此处定义的函数会生成ABI文件供外部调用
    BCWASM_ABI(demo::FirstDemo，setName)
    BCWASM_ABI(demo::FirstDemo，getName)</code></pre>

<p>合约编译后会产生demo.cpp.abi.json和demo.wasm，在生成java合约代码时需要用到这两个文件。</p>
</li>
<li>
<p>使用合约骨架生成工具生成java合约骨架:</p>
<pre class="codehilite"><code class="language-shell">
    cd java_sdk_linux_v0.9.0/java-sdk/bin
    ./client-sdk wasm generate --javaTypes      \
            &lt;/path/to/demo.wasm&gt;                \
            &lt;/path/to/demo.cpp.abi.json&gt;        \
            -o &lt;/path/to/src/main/java&gt;         \
            -p &lt;com.your.organisation.name&gt;     \
            -t wasm</code></pre>

</li>
</ol>
<p>说明：把尖括号内的内容替换成自己的内容。
   运行后会生成合约对应的java类。
   java类中包含了合约中的方法，方便在应用层中调用合约。</p>
<h3 id="32">3.2 合约操作</h3>
<ol>
<li>
<p>部署合约</p>
<pre class="codehilite"><code class="language-java">
    //optional
    class NodeConfiguration {
            public static final String WALLETSOURCE = "/home/username/Work/PlatONE/data/keystore/keyfile.json";
            public static final String DEMOBIN = "/home/user/Work/client-sdk-0.4.1/contract/firstdemo.wasm";
        }

    //建立连接
    Web3j web3j = Web3j.build(new HttpService("http://127.0.0.1:6791"));

    //加载钱包
    Credentials credentials = WalletUtils.loadCredentials("&lt;wallet password&gt;"，NodeConfiguration.WALLETSOURCE);

    //部署合约  
    byte[] dataBytes = Files.readBytes(new File(NodeConfiguration.DEMOBIN));
    String binData = Hex.toHexString(dataBytes);
    Firstdemo demo = Firstdemo.deploy(web3j，credentials，binData，new DefaultWasmGasProvider()).send();</code></pre>

</li>
<li>
<p>加载合约</p>
<pre class="codehilite"><code class="language-java">
    //optional
    class NodeConfiguration {
            public static final String WALLETSOURCE = "/home/username/Work/PlatONE/data/keystore/keyfile.json";
            public static final String DEMOBIN = "/home/user/Work/client-sdk-0.4.0/contract/firstdemo.wasm";
        }

    //建立连接
    Web3j web3j = Web3j.build(new HttpService("http://127.0.0.1:6791"));

    //加载钱包
    Credentials credentials = WalletUtils.loadCredentials("&lt;wallet password&gt;"，NodeConfiguration.WALLETSOURCE);

    //加载合约
    byte[] dataBytes = Files.readBytes(new File(NodeConfiguration.DEMOBIN));
    String binData = Hex.toHexString(dataBytes);
    Firstdemo contract = Firstdemo.load(binData，“&lt;contract address&gt;”，web3j，credentials，new DefaultWasmGasProvider());</code></pre>

</li>
<li>
<p>调用合约示例</p>
<p>在合约部署后，客户端可以通过合约地址进行合约调用。</p>
<ol>
<li>
<p>合约地址</p>
<pre class="codehilite"><code class="language-java">
    public  static void main(String args[]) {

        Web3j web3j = Web3j.build(new HttpService("http://127.0.0.1:6791"));

        try {
            // 密钥账户，keyfile.json为ethkey工具生成的账户文件，参照《PlatONE密钥工具文档》
            Credentials credentials = WalletUtils.loadCredentials("1"，"/home/wxuser/keyfile.json");

            // 合约数据
            byte[] dataBytes = Files.readBytes(new File("/home/user/PlatONE-Workspace-0.2/contracts/build/appContract/demo/demo.wasm"));
            String binData = Hex.toHexString(dataBytes);

            // 加载合约
            Demo demo = Demo.load(binData，"0x1d7f2695b43be56f52f24baa199420f8c10ac1d3"，web3j，credentials，new DefaultWasmGasProvider());

            // 调用demo合约的setName方法，参数输入字符串"platone"
            TransactionReceipt ret = demo.setName("platone").send();
            System.out.println("Transaction Hash: "+ret.getTransactionHash());

            // 调用demo合约的getName方法
            System.out.println("getName: " +  demo.getName().send());

        }catch (Exception e){
            System.out.println(e);
        }
    }</code></pre>

</li>
<li>
<p>合约名称</p>
<pre class="codehilite"><code class="language-java">
    public static void main(String[] args) {
        try {
            Web3j web3j = Web3j.build(new HttpService("http://127.0.0.1:6791"));
            Credentials credentials = WalletUtils.loadCredentials("1"，"/home/wxuser/keyfile.json");
            byte[] dataBytes = Files.readBytes(new File("/home/user/PlatONE-Workspace-0.2/contracts/build/appContract/demo/demo.wasm"));
            String binData = Hex.toHexString(dataBytes);
            // load contract
            CnsManager cns = CnsManager.load(null，"0x0000000000000000000000000000000000000011"，web3j，credentials，new DefaultWasmGasProvider());
            TransactionReceipt r = cns.cnsRegister("demo"，"1.0.0.0"，"0x1d7f2695b43be56f52f24baa199420f8c10ac1d3").send();
            if (r.isStatusOK()){
                Demo d = Demo.load(null，"demo"，web3j，c，new DefaultWasmGasProvider());
                d.setName("cns").send();
                System.out.println(d.getName().send());
                }

        } catch (Exception e) {
            e.printStackTrace();
        } finally {
            System.out.println("Done...");
        }
    }</code></pre>

</li>
</ol>
</li>
</ol>
<h3 id="33">3.3 订阅事件</h3>
<ol>
<li>订阅区块:</li>
</ol>
<p>在新区块产生时，client可以得到节点的区块数据推送。</p>
<pre class="codehilite"><code class="language-java">
     Subscription sub = web3j.blockObservable(false).subscribe( block -&gt; {
         System.out.println(block.getBlock().getNumber());
     });</code></pre>

<ol>
<li>订阅event:</li>
</ol>
<p>在合约中可以自定义事件，client通过订阅事件的方式来获悉合约调用中所触发的事件。</p>
<p>合约中定义如下的event，每次setName被调用时，就会触发该event。</p>
<pre class="codehilite"><code class="language-c++">
 // event定义
 BCWASM_EVENT(setName，const char *)

 void setName(const char *msg)
 {
     // 定义状态变量
     bcwasm::setState("NAME_KEY"，std::string(msg));
     // 日志输出
     // 事件返回
     BCWASM_EMIT_EVENT(setName，"std::string(msg)");
 }</code></pre>

<pre class="codehilite"><code class="language-java">
 String contractAddress = "0x1d7f2695b43be56f52f24baa199420f8c10ac1d3";
 String eventHash = Hash.sha3String("setName");

 EthFilter filter = new EthFilter(DefaultBlockParameterName.EARLIEST，DefaultBlockParameterName.LATEST，contractAddress).addSingleTopic(eventHash);

 Subscription subTx = web3j.ethLogObservable(filter).subscribe(log -&gt; {
     System.out.println("output: " + log.getData());
 }</code></pre>

<p>说明：Filter实例化的输入，第三个是合约的地址，第四个是Topic的哈希值（SHA-3），返回结果中log的Data字段是事件值的rlp编码。</p>
<h3 id="34-web3-api">3.4 web3 api调用</h3>
<pre class="codehilite"><code class="language-java">web3j.ethBlockNumber(); // 当前最新区块高度
web3j.ethGetTransactionByHash("0x..."); // 根据交易哈希多去交易内容
web3j.ethGetTransactionReceipt("0x..."); // 根据交易哈希获取交易的回执</code></pre>

  <br>
    

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../%E6%B5%8F%E8%A7%88%E5%99%A8/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%B5%8F%E8%A7%88%E5%99%A8%E9%85%8D%E7%BD%AE/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../%E6%B5%8F%E8%A7%88%E5%99%A8/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%B5%8F%E8%A7%88%E5%99%A8%E9%85%8D%E7%BD%AE/" class="btn btn-xs btn-link">
        浏览器
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../SDK%E6%A6%82%E8%BF%B0/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../SDK%E6%A6%82%E8%BF%B0/" class="btn btn-xs btn-link">
        SDK概述
      </a>
    </div>
    
  </div>

    <br>
</div>

<footer class="container-fluid wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>